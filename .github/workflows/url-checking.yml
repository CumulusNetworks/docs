name: 'URL Checker'

on: [push, pull_request]

jobs:
  check_urls:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout git repo
      uses: actions/checkout@v2
    - name: Download and install Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: "0.82.0"
        extended: true
    - name: Update link shortcode to error on broken links
      run: sed -i 's/#ERROR/\<{{ errorf "broken link in %s" .Position }}\>/g' themes/netDocs/layouts/shortcodes/link.html
    - name: Run Hugo
      run: hugo
    - name: Grep for bad links
      run: echo "GREP_OUTPUT=$(grep -ro --exclude='*/pdf/index.html' --include='*.html' '<code>&lt;a rel=&quot;canonical&quot; href=&quot;' public/)" >> $GITHUB_ENV
    - name: Print any bad kb_links
      run: echo $GREP_OUTPUT
    - name: Exit based on Grep result
      run: (exit $(echo $GREP_OUTPUT | wc -l))