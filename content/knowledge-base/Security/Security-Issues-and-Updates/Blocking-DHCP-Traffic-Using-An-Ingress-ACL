---
title: Blocking DHCP Traffic Using an Ingress ACL
author: NVIDIA
weight: 459
toc: 5
---

## Issue

Due to the forwarding pipeline in Cumulus Linux, a traditional ACL cannot be used to constrain (block) DHCP traffic. DHCP traffic is discarded in hardware and software forwarded by the CPU (trapped). Therefore, an IP ACL applied to match DHCP traffic will show as matching on the statistics counter but not actually drop the traffic. For example take the the following ACL that is applied to SWP1:

  nv set acl BLOCK_DHCP rule 10 action deny
  nv set acl BLOCK_DHCP rule 10 match ip protocol udp
  nv set acl BLOCK_DHCP rule 10 match ip source-port 68
  nv set acl BLOCK_DHCP type ipv4

  nv set interface swp1 acl BLOCK_DHCP inbound

The host attachd on swp1 is configured to request an IP via DHCP. We can see that there is a match on the DHCP traffic. However this traffic is not actually blocked since this is a hardware counter only and the forwarding pipeline is via a software path:

  cumulus@switch:/home/cumulus# nv show interface swp1 acl BLOCK_DHCP statistics

  Rule  In Packet  In Byte    Out Packet  Out Byte  Summary
  ----  ---------  ---------  ----------  --------  ------------------------
  10    2          692 Bytes                        match.ip.protocol:   udp <<<<
                                                    match.ip.source-port: 68
## Environment

-This issue impacts all version of Cumulus Linux up to and including 5.6.0 which is the most recent at the time of this writing.  
-Future versions may include the capability to constrain this traffic using normal IP ACL rules seemlessly.

## Resolution

Create an IP access list to match on physdev device. 

1. Run the following to enable process of tagged packets by netfilter:

  cumulus@switch:~$ sudo sysctl -w net.bridge.bridge-nf-filter-vlan-tagged=1

Note: To make this setting persist you must add the line "net.bridge.bridge-nf-filter-vlan-tagged = 1" to /etc/sysctl.conf. A correct config looks like this:

  cumulus@switch:~$  cat /etc/sysctl.conf | grep vlan
  net.bridge.bridge-nf-filter-vlan-tagged = 1

2. In the folder "/etc/cumulus/acl/policy.d/" add a filed named "75BlockDHCP.rules" with the following contents:

  [iptables]
  -A FORWARD -m physdev --physdev-in swp1 -p udp --sport 68 -j DROP

Note: this example blocks ingress DHCP on swp1. If you which to apply the rule to all interfaces you can use the wildcard syntax (swp+) which will apply the rule to all switch ports.

3. Apply the rule: 

  cumulus@switch:~$ sudo cl-acltool -i

4. Verify the rule is applied. Note, that this counter does not increment.

  cumulus@switch:~$ sudo cl-acltool -L ip | grep udp
    0     0 DROP       udp  --  any    any     anywhere             anywhere             PHYSDEV match --physdev-in swp1 udp spt:bootpc
