<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Border Gateway Protocol - BGP | Cumulus Networks Documentation</title>

  
  <link href="https://fonts.googleapis.com/css?family=Oxygen|Oxygen+Mono:300,400,700" rel="stylesheet">

  
  
  
  <link rel="stylesheet" href="/book.min.a4ec20f62c4bbaad99f9db40524ec8653f6279bcde229add21ff46dfd05dfa96.css">

  
  <link rel="icon" href="/favicon.png" type="image/x-icon">

  
  <!--
  Made with Book Theme
  https://github.com/alex-shpak/hugo-book
  -->

</head>


<body>
  <input type="checkbox" style="display: none" id="menu-control" />
  
  <header id="site-nav">
    <div class="header-wrapper flex">
      <a href="/">
        <img src="/header-logo.png" alt="Cumulus Networks">
        <img src="/cumulus-networks-rt-white.svg" alt="Cumulus Networks" class="header-mobile">
        <span>Docs</span>
      </a>
      <ul class="flex">
        <li><a href="//cumulusnetworks.com">HOME</a></li>
        <li><a href="//support.cumulusnetworks.com/">SUPPORT</a></li>
        <li><a href="//docs.cumulusnetworks.com/">DOCS</a></li>
        <li><a href="//education.cumulusnetworks.com">EDUCATION</a></li>
        <li><a href="//cumulusnetworks.com/blog/">BLOG</a></li>
        <li><a href="//forums.cumulusnetworks.com/">FORUMS</a></li>
      </ul>
      <div class="burger-menu">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </header>
  <div id="product-nav" class="flex">
    <ul>
      <li class="active"><a href="/Cumulus_Linux/">Cumulus Linux</a></li>
      <li><a href="/Cumulus_NetQ/">Cumulus NetQ</a></li>
      <li><a href="/Chassis/">Cumulus Express</a></li>
      <li><a href="">Cumulus VX</a></li>
    </ul>
    <div class="search-container">
      <div id="doc-search-box">
        <input type="text" class="doc-search-input" placeholder="Search" value="">
        <span><button type="submit"><img src="/icons/search_20x20.svg" alt=""></button></span>
      </div>
      <div id="dropdown" class="dropdown">
          <button class="btn" type="button" id="dropdownMenuButton">
            v3.76
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="#">v3.5</a>
            <a class="dropdown-item" href="#">v2.1</a>
            <a class="dropdown-item" href="#">v1.43</a>
          </div>
      </div>
    </div>
  </div>
  <main class="flex container">
    <aside class="book-menu fixed">

      <nav role="navigation">
        <h2 class="book-brand">
          <a href="http://example.org/">Cumulus Networks Documentation</a>
        </h2>
        
        




  <ul class = "cn-book-section-container" id = "top">
    
        
          
            

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/" >
    Cumulus Linux 3.5
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Cumulus_Linux_User_Guide/" >
    Cumulus Linux User Guide
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Quick_Start_Guide/" >
    Quick Start Guide
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Installation_Management/" >
    Installation Management
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Installation_Management/Managing_Cumulus_Linux_Disk_Images/" >
    Managing Cumulus Linux Disk Images
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Installation_Management/Installing_a_New_Cumulus_Linux_Image/" >
    Installing a New Cumulus Linux Image
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Installation_Management/Upgrading_Cumulus_Linux/" >
    Upgrading Cumulus Linux
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Installation_Management/Using_Snapshots/" >
    Using Snapshots
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Installation_Management/Adding_and_Updating_Packages/" >
    Adding and Updating Packages
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Installation_Management/Zero_Touch_Provisioning_-_ZTP/" >
    Zero Touch Provisioning - ZTP
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/" >
    System Configuration
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Network_Command_Line_Utility_-_NCLU/" >
    Network Command Line Utility - NCLU
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Network_Command_Line_Utility_-_NCLU/Network_Command_Line_Utility/" >
    Network Command Line Utility
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Authentication_Authorization_and_Accounting/" >
    Authentication, Authorization and Accounting
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Authentication_Authorization_and_Accounting/SSH_for_Remote_Access/" >
    SSH for Remote Access
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Authentication_Authorization_and_Accounting/User_Accounts/" >
    User Accounts
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Authentication_Authorization_and_Accounting/Using_sudo_to_Delegate_Privileges/" >
    Using sudo to Delegate Privileges
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Authentication_Authorization_and_Accounting/LDAP_Authentication_and_Authorization/" >
    LDAP Authentication and Authorization
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Authentication_Authorization_and_Accounting/TACACS_Plus/" >
    TACACS Plus
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Authentication_Authorization_and_Accounting/RADIUS_AAA/" >
    RADIUS AAA
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Netfilter_-_ACLs/" >
    Netfilter - ACLs
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Netfilter_-_ACLs/Default_Cumulus_Linux_ACL_Configuration/" >
    Default Cumulus Linux ACL Configuration
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Netfilter_-_ACLs/Filtering_Learned_MAC_Addresses/" >
    Filtering Learned MAC Addresses
  </a>


    </li>
    
  </ul>


  </li>


    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Setting_Date_and_Time/" >
    Setting Date and Time
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Managing_Application_Daemons/" >
    Managing Application Daemons
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Configuring_switchd/" >
    Configuring switchd
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Power_over_Ethernet_-_PoE/" >
    Power over Ethernet - PoE
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/Configuring_a_Global_Proxy/" >
    Configuring a Global Proxy
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/System_Configuration/HTTP_API/" >
    HTTP API
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Interface_Configuration_and_Management/" >
    Interface Configuration and Management
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Interface_Configuration_and_Management/Buffer_and_Queue_Management/" >
    Buffer and Queue Management
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Interface_Configuration_and_Management/Buffer_and_Queue_Management/Configuring_Hardware-enabled_DDOS_Protection/" >
    Configuring Hardware-enabled DDOS Protection
  </a>


    </li>
    
  </ul>


  </li>


    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Interface_Configuration_and_Management/Layer_1_and_Switch_Port_Attributes/" >
    Layer 1 and Switch Port Attributes
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Interface_Configuration_and_Management/Configuring_DHCP_Relays/" >
    Configuring DHCP Relays
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Interface_Configuration_and_Management/Configuring_DHCP_Servers/" >
    Configuring DHCP Servers
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Interface_Configuration_and_Management/802.1X_Interfaces/" >
    802.1X Interfaces
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/" >
    Layer 1 and 2
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Link_Layer_Discovery_Protocol/" >
    Link Layer Discovery Protocol
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Link_Layer_Discovery_Protocol/Voice_VLAN/" >
    Voice VLAN
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Ethernet_Bridging_-_VLANs/" >
    Ethernet Bridging - VLANs
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Ethernet_Bridging_-_VLANs/VLAN-aware_Bridge_Mode_for_Large-scale_Layer_2_Environments/" >
    VLAN-aware Bridge Mode for Large-scale Layer 2 Environments
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Ethernet_Bridging_-_VLANs/Traditional_Mode_Bridges/" >
    Traditional Mode Bridges
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Ethernet_Bridging_-_VLANs/VLAN_Tagging/" >
    VLAN Tagging
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Virtual_Router_Redundancy_-_VRR/" >
    Virtual Router Redundancy - VRR
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Virtual_Router_Redundancy_-_VRR/ifplugd/" >
    ifplugd
  </a>


    </li>
    
  </ul>


  </li>


    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Spanning_Tree_and_Rapid_Spanning_Tree/" >
    Spanning Tree and Rapid Spanning Tree
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Prescriptive_Topology_Manager_-_PTM/" >
    Prescriptive Topology Manager - PTM
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Bonding_-_Link_Aggregation/" >
    Bonding - Link Aggregation
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/Multi-Chassis_Link_Aggregation_-_MLAG/" >
    Multi-Chassis Link Aggregation - MLAG
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/LACP_Bypass/" >
    LACP Bypass
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_1_and_2/IGMP_and_MLD_Snooping/" >
    IGMP and MLD Snooping
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/" >
    Network Virtualization
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Static_VXLAN_Configurations/" >
    Static VXLAN Configurations
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Static_VXLAN_Configurations/Static_VXLAN_Tunnels/" >
    Static VXLAN Tunnels
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Static_VXLAN_Configurations/Static_MAC_Bindings_with_VXLAN/" >
    Static MAC Bindings with VXLAN
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Lightweight_Network_Virtualization_-_LNV_Overview/" >
    Lightweight Network Virtualization - LNV Overview
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Lightweight_Network_Virtualization_-_LNV_Overview/LNV_VXLAN_Active-Active_Mode/" >
    LNV VXLAN Active-Active Mode
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Lightweight_Network_Virtualization_-_LNV_Overview/LNV_Full_Example/" >
    LNV Full Example
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Virtualization_Integrations/" >
    Virtualization Integrations
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Virtualization_Integrations/Integrating_Hardware_VTEPs_with_Midokura_MidoNet_and_OpenStack/" >
    Integrating Hardware VTEPs with Midokura MidoNet and OpenStack
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Virtualization_Integrations/Integrating_Hardware_VTEPs_with_VMware_NSX-V/" >
    Integrating Hardware VTEPs with VMware NSX-V
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Virtualization_Integrations/Integrating_Hardware_VTEPs_with_VMware_NSX/" >
    Integrating Hardware VTEPs with VMware NSX
  </a>


    </li>
    
  </ul>


  </li>


    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Ethernet_Virtual_Private_Network_-_EVPN/" >
    Ethernet Virtual Private Network - EVPN
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/VXLAN_Routing/" >
    VXLAN Routing
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/VXLAN_Scale/" >
    VXLAN Scale
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Virtualization/Hybrid_Cloud_Connectivity_with_QinQ_and_VXLANs/" >
    Hybrid Cloud Connectivity with QinQ and VXLANs
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Layer_3/" >
    Layer 3
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Layer_3/FRRouting_Overview/" >
    FRRouting Overview
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/FRRouting_Overview/Upgrading_from_Quagga_to_FRRouting/" >
    Upgrading from Quagga to FRRouting
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Configuring_FRRouting/" >
    Configuring FRRouting
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Configuring_FRRouting/Comparing_NCLU_and_vtysh_Commands/" >
    Comparing NCLU and vtysh Commands
  </a>


    </li>
    
  </ul>


  </li>


    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Routing/" >
    Routing
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Introduction_to_Routing_Protocols/" >
    Introduction to Routing Protocols
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Network_Topology/" >
    Network Topology
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Open_Shortest_Path_First_-_OSPF_-_Protocol/" >
    Open Shortest Path First - OSPF - Protocol
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Open_Shortest_Path_First_v3_-_OSPFv3_-_Protocol/" >
    Open Shortest Path First v3 - OSPFv3 - Protocol
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Border_Gateway_Protocol_-_BGP/"  class="active" >
    Border Gateway Protocol - BGP
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Bidirectional_Forwarding_Detection_-_BFD/" >
    Bidirectional Forwarding Detection - BFD
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Equal_Cost_Multipath_Load_Sharing_-_Hardware_ECMP/" >
    Equal Cost Multipath Load Sharing - Hardware ECMP
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Redistribute_Neighbor/" >
    Redistribute Neighbor
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Virtual_Routing_and_Forwarding_-_VRF/" >
    Virtual Routing and Forwarding - VRF
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Management_VRF/" >
    Management VRF
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Protocol_Independent_Multicast_-_PIM/" >
    Protocol Independent Multicast - PIM
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Layer_3/Segment_Routing/" >
    Segment Routing
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/" >
    Monitoring and Troubleshooting
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Monitoring_System_Hardware/" >
    Monitoring System Hardware
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Monitoring_System_Hardware/Network_Switch_Port_LED_and_Status_LED_Guidelines/" >
    Network Switch Port LED and Status LED Guidelines
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Understanding_the_cl-support_Output_File/" >
    Understanding the cl-support Output File
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Understanding_the_cl-support_Output_File/Troubleshooting_Log_Files/" >
    Troubleshooting Log Files
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Understanding_the_cl-support_Output_File/Troubleshooting_the_etc_Directory/" >
    Troubleshooting the etc Directory
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Troubleshooting_Network_Interfaces/" >
    Troubleshooting Network Interfaces
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Troubleshooting_Network_Interfaces/Monitoring_Interfaces_and_Transceivers_Using_ethtool/" >
    Monitoring Interfaces and Transceivers Using ethtool
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Network_Troubleshooting/" >
    Network Troubleshooting
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Network_Troubleshooting/Using_NCLU_to_Troubleshoot_Your_Network_Configuration/" >
    Using NCLU to Troubleshoot Your Network Configuration
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Network_Troubleshooting/Monitoring_System_Statistics_and_Network_Traffic_with_sFlow/" >
    Monitoring System Statistics and Network Traffic with sFlow
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/SNMP_Monitoring/" >
    SNMP Monitoring
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/SNMP_Monitoring/Using_Nutanix_Prism_as_a_Monitoring_Tool/" >
    Using Nutanix Prism as a Monitoring Tool
  </a>


    </li>
    
  </ul>


  </li>


    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Single_User_Mode_-_Boot_Recovery/" >
    Single User Mode - Boot Recovery
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Resource_Diagnostics_Using_cl-resource-query/" >
    Resource Diagnostics Using cl-resource-query
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Monitoring_Virtual_Device_Counters/" >
    Monitoring Virtual Device Counters
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Buffer_Monitoring/" >
    Buffer Monitoring
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Monitoring_and_Troubleshooting/Monitoring_Best_Practices/" >
    Monitoring Best Practices
  </a>


    </li>
    
  </ul>


  </li>


    
      

  <li class="cn-book-section">
      

  <a href="/version/Cumulus_Linux_35/Network_Solutions/" >
    Network Solutions
  </a>



      

  <ul class="cn-book-section-container" id = "subsection">
    
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Solutions/Data_Center_Host_to_ToR_Architecture/" >
    Data Center Host to ToR Architecture
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Solutions/Cumulus_Networks_Services_Demos/" >
    Cumulus Networks Services Demos
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Solutions/Docker_on_Cumulus_Linux/" >
    Docker on Cumulus Linux
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Solutions/OpenStack_Neutron_ML2_and_Cumulus_Linux/" >
    OpenStack Neutron ML2 and Cumulus Linux
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Solutions/Anycast_Design_Guide/" >
    Anycast Design Guide
  </a>


    </li>
    
    <li >
      

  <a href="/version/Cumulus_Linux_35/Network_Solutions/RDMA_over_Converged_Ethernet_-_RoCE/" >
    RDMA over Converged Ethernet - RoCE
  </a>


    </li>
    
  </ul>


  </li>


    
    
  </ul>


  </li>


          
      
          
      
          
      
    
  </ul>









      </nav>

      
      
      
      

      <script src = "http://example.org/js/menuBundle.js"> </script>

    </aside>

    <div class="book-page">

      
      <header class="align-center justify-between book-header">
        <label for="menu-control">
          <img src="/svg/menu.svg" alt="Menu" />
        </label>
        <strong>Border Gateway Protocol - BGP</strong>
      </header>

      
      
<article class="markdown">
<h1>Border Gateway Protocol - BGP</h1>

<p>BGP is the routing protocol that runs the Internet. It is an
increasingly popular protocol for use in the data center as it lends
itself well to the rich interconnections in a Clos topology.
Specifically, BGP:</p>

<ul>
<li><p>Does not require routing state to be periodically refreshed, unlike
OSPF.</p></li>

<li><p>Is less chatty than its link-state siblings. For example, a link or
node transition can result in a bestpath change, causing BGP to send
updates.</p></li>

<li><p>Is multi-protocol and extensible.</p></li>

<li><p>Has many robust vendor implementations.</p></li>

<li><p>Is very mature as a protocol and comes with many years of
operational experience.</p></li>
</ul>

<p><a href="https://tools.ietf.org/html/rfc7938" target="_blank">RFC 7938</a> provides further details
of the use of BGP within the data center.</p>

<h2 id="autonomous-system-number-asn">Autonomous System Number (ASN)</h2>

<p>One of the key concepts in BGP is an <em>autonomous</em> <em>system number</em> or
ASN. An <a href="https://en.wikipedia.org/wiki/Autonomous_System_%28Internet%29" target="_blank">autonomous
system</a>
is defined as a set of routers under a common administration. Because
BGP was originally designed to peer between independently managed
enterprises and/or service providers, each such enterprise is treated as
an autonomous system, responsible for a set of network addresses. Each
such autonomous system is given a unique number called its ASN. ASNs are
handed out by a central authority (ICANN). However, ASNs between 64512
and 65535 are reserved for private use. Using BGP within the data center
relies on either using this number space or using the single ASN you
own.</p>

<p>The ASN is central to how BGP builds a forwarding topology. A BGP route
advertisement carries with it not only the originator’s ASN, but also
the list of ASNs that this route advertisement has passed through. When
forwarding a route advertisement, a BGP speaker adds itself to this
list. This list of ASNs is called the <em>AS path</em>. BGP uses the AS path to
detect and avoid loops.</p>

<p>ASNs were originally 16-bit numbers, but were later modified to be
32-bit. FRRouting supports both 16-bit and 32-bit ASNs, but most
implementations still run with 16-bit ASNs.</p>

<h2 id="ebgp-and-ibgp">eBGP and iBGP</h2>

<p>When BGP is used to peer between autonomous systems, the peering is
referred to as <em>external BGP</em> or eBGP. When BGP is used within an
autonomous system, the peering used is referred to as <em>internal BGP</em> or
iBGP. eBGP peers have different ASNs while iBGP peers have the same ASN.</p>

<p>The heart of the protocol is the same when used as eBGP or iBGP,
however, there is a key difference in the protocol behavior between use
as eBGP and iBGP: an iBGP speaker does not forward routing information
learned from one iBGP peer to another iBGP peer to prevent loops. eBGP
prevents loops using the AS_Path attribute.</p>

<p>All iBGP speakers need to be peered with each other in a full mesh. In a
large network, this requirement can quickly become unscalable. The most
popular method to scale iBGP networks is to introduce a <em>route
reflector</em>.</p>

<h2 id="route-reflectors">Route Reflectors</h2>

<p>Route reflectors are quite easy to understand in a Clos topology. In a
two-tier Clos network, the leaf (or tier 1) switches are the only ones
connected to end stations. Subsequently, this means that the spines
themselves do not have any routes to announce; they are merely
<strong>reflecting</strong> the routes announced by one leaf to the other leaves.
Therefore, the spine switches function as route reflectors while the
leaf switches serve as route reflector clients.</p>

<p>In a three-tier network, the tier 2 nodes (or mid-tier spines) act as
both route reflector servers and route reflector clients. They act as
route reflectors because they announce the routes learned from the tier
1 nodes to other tier 1 nodes and to tier 3 nodes. They also act as
route reflector clients to the tier 3 nodes, receiving routes learned
from other tier 2 nodes. Tier 3 nodes act only as route reflectors.</p>

<p>In the following illustration, tier 2 node 2.1 is acting as a route
reflector server, announcing the routes between tier 1 nodes 1.1 and 1.2
to tier 1 node 1.3. It is also a route reflector client, learning the
routes between tier 2 nodes 2.2 and 2.3 from the tier 3 node, 3.1.</p>








<img class = "confluence-embedded-image confluence-thumbnail" src = "/undefinedimages/download/thumbnails/8357722/bgp&#43;route&#43;reflectors.png" alt = "/undefinedimages/download/thumbnails/8357722/bgp&#43;route&#43;reflectors.png"


width = 300

 />



<div class="notices note" > <p>When configuring a router to be a route reflector client, you must
specify the FRRouting configuration in a specific order; otherwise, the
router will not be a route reflector client.</p>

<p>You must run the <code>net add bgp neighbor &lt;IPv4/IPV6&gt;
route-reflector-client</code> command after the <code>net add bgp neighbor
&lt;IPV4/IPV6&gt; activate</code> command; otherwise, the <code>route-reflector-client</code>
command is ignored. For example:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp ipv4 unicast neighbor 14.0.0.9 activate 
cumulus@switch:~$ net add bgp neighbor 14.0.0.9 next-hop-self
cumulus@switch:~$ net add bgp neighbor 14.0.0.9 route-reflector-client &gt;&gt;&gt; Must be after activate 
cumulus@switch:~$ net add bgp neighbor 2001:ded:beef:2::1 remote-as 65000
cumulus@switch:~$ net add bgp ipv6 unicast redistribute connected
cumulus@switch:~$ net add bgp maximum-paths ibgp 4 
cumulus@switch:~$ net add bgp neighbor 2001:ded:beef:2::1 activate 
cumulus@switch:~$ net add bgp neighbor 2001:ded:beef:2::1 next-hop-self 
cumulus@switch:~$ net add bgp neighbor 2001:ded:beef:2::1 route-reflector-client &gt;&gt;&gt; Must be after activate 
   
    
</code></pre>
 </div>


<h3 id="configuring-clusters">Configuring Clusters</h3>

<p>A cluster consists of route reflectors (RRs) and their clients and is
used in iBGP environments where multiple sets of route reflectors and
their clients are configured. Configuring a unique ID per cluster (on
the route reflector server and clients) prevents looping as a route
reflector does not accept routes from another that has the same cluster
ID. Additionally, because all route reflectors in the cluster recognize
updates from peers in the same cluster, they do not install routes from
a route reflector in the same cluster; this reduces the number of
updates that need to be stored in BGP routing tables.</p>

<p>To configure a cluster ID on a route reflector, run the <code>net add bgp
cluster-id (&lt;ipv4&gt;|&lt;1-4294967295&gt;)</code> command. You can enter the cluster
ID as an IP address or as a 32-bit quantity.</p>

<p>The following example configures a cluster ID on a route reflector in IP
address format:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp cluster-id 14.0.0.9
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit
   
    
</code></pre>

<p>The following example configures a cluster ID on a route reflector as a
32-bit quantity:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp cluster-id 321
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit
   
    
</code></pre>

<h2 id="ecmp-with-bgp">ECMP with BGP</h2>

<p>If a BGP node hears a prefix <strong>p</strong> from multiple peers, it has all the
information necessary to program the routing table to forward traffic
for that prefix <strong>p</strong> through all of these peers; BGP supports
equal-cost multipathing (ECMP).</p>

<p>To perform ECMP in BGP, you may need to configure <code>net add bgp bestpath
as-path multipath-relax</code> (if you are using eBGP).</p>

<h3 id="maximum-paths">Maximum Paths</h3>

<p>In Cumulus Linux, the BGP <code>maximum-paths</code> setting is enabled by default,
so multiple routes are already installed. The default setting is 64
paths.</p>

<h3 id="bgp-for-both-ipv4-and-ipv6">BGP for Both IPv4 and IPv6</h3>

<p>Unlike OSPF, which has separate versions of the protocol to announce
IPv4 and IPv6 routes, BGP is a multi-protocol routing engine, capable of
announcing both IPv4 and IPv6 prefixes. It supports announcing IPv4
prefixes over an IPv4 session and IPv6 prefixes over an IPv6 session. It
also supports announcing prefixes of both these address families over a
single IPv4 session or over a single IPv6 session.</p>

<h2 id="configuring-bgp">Configuring BGP</h2>

<p>A basic BGP configuration looks like the following. However, the rest of
this chapter discusses how to configure various other features, from
unnumbered interfaces to route maps.</p>

<ol>
<li><p>Enable the BGP and Zebra daemons, <code>zebra</code> and <code>bgpd</code>, then enable
the FRRouting service and start it, as described in <a href="/old/Cumulus_Linux_35/Configuring_FRRouting.html">Configuring
FRRouting</a>.</p></li>

<li><p>Identify the BGP node by assigning an ASN and <code>router-id</code>:</p>

<pre><code>                       
cumulus@switch:~$ net add bgp autonomous-system 65000
cumulus@switch:~$ net add bgp router-id 10.0.0.1
       
        
</code></pre></li>

<li><p>Specify where to disseminate routing information:</p>

<pre><code>                       
cumulus@switch:~$ net add bgp neighbor 10.0.0.2 remote-as external
       
        
</code></pre>

<p>If it is an iBGP session, the <code>remote-as</code> is the same as the local
AS:</p>

<pre><code>                       
cumulus@switch:~$ net add bgp neighbor 10.0.0.2 remote-as internal
       
        
</code></pre>

<p>Specifying the IP address of the peer, allows BGP to set up a TCP
socket with this peer, but it doesn’t distribute any prefixes to it,
unless it is explicitly told that it must with the <code>activate</code>
command:</p>

<pre><code>                       
cumulus@switch:~$ net add bgp ipv4 unicast neighbor 10.0.0.2 activate
cumulus@switch:~$ net add bgp ipv6 unicast neighbor 2001:db8:0002::0a00:0002 activate
       
        
</code></pre>

<p>As you can see, <code>activate</code> has to be specified for each address
family that is being announced by the BGP session.</p></li>

<li><p>Specify some properties of the BGP session:</p>

<pre><code>                       
cumulus@switch:~$ net add bgp neighbor 10.0.0.2 next-hop-self
       
        
</code></pre>

<p>If this is a route-reflector client, it can be specified as follows:</p>

<pre><code>                       
cumulus@switchRR:~$ net add bgp neighbor 10.0.0.1 route-reflector-client
       
        
</code></pre>


<div class="notices note" > <pre><code>It is node *switchRR*, the route reflector, on which the peer is
specified as a client.
</code></pre>
 </div>
</li>

<li><p>Specify what prefixes to originate:</p>

<pre><code>                       
cumulus@switch:~$ net add bgp ipv4 unicast network 192.0.2.0/24
cumulus@switch:~$ net add bgp ipv4 unicast network 203.0.113.1/24
cumulus@switch:~$ net pending
cumulus@switch:~$ net commit
       
        
</code></pre></li>
</ol>

<h2 id="using-bgp-unnumbered-interfaces">Using BGP Unnumbered Interfaces</h2>

<p>Unnumbered interfaces are interfaces without unique IP addresses. In
BGP, you configure unnumbered interfaces using <em>extended next-hop
encoding</em> (ENHE), which is defined by
<a href="https://tools.ietf.org/html/rfc5549" target="_blank">RFC 5549</a>. BGP unnumbered
interfaces provide a means of advertising an IPv4 route with an IPv6
next-hop. Prior to RFC 5549, an IPv4 route could be advertised only with
an IPv4 next-hop.</p>

<p>BGP unnumbered interfaces are particularly useful in deployments where
IPv4 prefixes are advertised through BGP over a section without any IPv4
address configuration on links. As a result, the routing entries are
also IPv4 for destination lookup and have IPv6 next-hops for forwarding
purposes.</p>

<h3 id="bgp-and-extended-next-hop-encoding">BGP and Extended Next-hop Encoding</h3>

<p>When enabled and active, BGP makes use of the available IPv6 next-hops
for advertising any IPv4 prefixes. BGP learns the prefixes, calculates
the routes and installs them in IPv4 AFI to IPv6 AFI format. However,
ENHE in Cumulus Linux does not install routes into the kernel in IPv4
prefix to IPv6 next-hop format. For link-local peerings enabled by
dynamically learning the other end&rsquo;s link-local address using IPv6
neighbor discovery router advertisements, an IPv6 next-hop is converted
into an IPv4 link-local address and a static neighbor entry is installed
for this IPv4 link-local address with the MAC address derived from the
link-local address of the other end.</p>


<div class="notices note" > <p>It is assumed that the IPv6 implementation on the peering device will
use the MAC address as the interface ID when assigning the IPv6
link-local address, as suggested by RFC 4291.</p>
 </div>


<h3 id="configuring-bgp-unnumbered-interfaces">Configuring BGP Unnumbered Interfaces</h3>

<p>Configuring a BGP unnumbered interface requires enabling IPv6 neighbor
discovery router advertisements. The <code>interval</code> you specify is measured
in seconds and defaults to 10 seconds. Extended next-hop encoding is
sent only for the link-local address peerings:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp autonomous-system 65020
cumulus@switch:~$ net add bgp router-id 10.0.0.21
cumulus@switch:~$ net add bgp bestpath as-path multipath-relax
cumulus@switch:~$ net add bgp bestpath compare-routerid
cumulus@switch:~$ net add bgp neighbor fabric peer-group
cumulus@switch:~$ net add bgp neighbor fabric remote-as external
cumulus@switch:~$ net add bgp neighbor fabric description Internal Fabric Network
cumulus@switch:~$ net add bgp neighbor fabric capability extended-nexthop
cumulus@switch:~$ net add bgp neighbor swp1 interface peer-group fabric
cumulus@switch:~$ net add bgp neighbor swp2 interface peer-group fabric
cumulus@switch:~$ net add bgp neighbor swp3 interface peer-group fabric
cumulus@switch:~$ net add bgp neighbor swp4 interface peer-group fabric
cumulus@switch:~$ net add bgp neighbor swp29 interface peer-group fabric
cumulus@switch:~$ net add bgp neighbor swp30 interface peer-group fabric
   
    
</code></pre>

<p>These commands create the following configuration in the
<code>/etc/frr/frr.conf</code> file:</p>

<pre><code>                   
router bgp 65020
 bgp router-id 10.0.0.21
 bgp bestpath as-path multipath-relax
 bgp bestpath compare-routerid
 neighbor fabric peer-group
 neighbor fabric remote-as external
 neighbor fabric description Internal Fabric Network
 neighbor fabric capability extended-nexthop
 neighbor swp1 interface peer-group fabric
 neighbor swp2 interface peer-group fabric
 neighbor swp3 interface peer-group fabric
 neighbor swp4 interface peer-group fabric
 neighbor swp29 interface peer-group fabric
 neighbor swp30 interface peer-group fabric
!
   
    
</code></pre>

<p>Notice above, for an unnumbered configuration, you can use a single
command to configure a neighbor and attach it to a <a href="/old/Cumulus_Linux_35/#src-8357722_BorderGatewayProtocol-BGP-peergroups">peer
group</a>
(making sure to substitute for the interface and peer group below):</p>

<pre><code>                   
cumulus@switch:~$ net add bgp neighbor  interface peer-group 
   
    
</code></pre>

<h3 id="managing-unnumbered-interfaces">Managing Unnumbered Interfaces</h3>

<p>All the relevant BGP commands are now capable of showing IPv6 next-hops
and/or the interface name for any IPv4 prefix:</p>

<pre><code>                   
cumulus@switch:~$ net show bgp
 
show bgp ipv4 unicast
=====================
BGP table version is 6, local router ID is 10.0.0.11
Status codes: s suppressed, d damped, h history, * valid, &gt; best, = multipath,
              i internal, r RIB-failure, S Stale, R Removed
Origin codes: i - IGP, e - EGP, ? - incomplete
   Network          Next Hop            Metric LocPrf Weight Path
*&gt; 10.0.0.11/32     0.0.0.0                  0         32768 ?
*&gt; 10.0.0.12/32     swp51                         0 65020 65012 ?
*=                  swp52                         0 65020 65012 ?
*&gt; 10.0.0.21/32     swp51           0             0 65020 ?
*&gt; 10.0.0.22/32     swp52           0             0 65020 ?
*&gt; 172.16.1.0/24    0.0.0.0                  0         32768 i
*&gt; 172.16.2.0/24    swp51                         0 65020 65012 i
*=                  swp52                         0 65020 65012 i
Total number of prefixes 6
 
show bgp ipv6 unicast
=====================
No BGP network exists
   
    
</code></pre>

<p>FRRouting RIB commands are also modified:</p>

<pre><code>                   
cumulus@switch:~$ net show route
RIB entry for route
===================
Codes: K - kernel route, C - connected, S - static, R - RIP,
       O - OSPF, I - IS-IS, B - BGP, P - PIM, T - Table,
       &gt; - selected route, * - FIB route
K&gt;* 0.0.0.0/0 via 192.168.0.254, eth0
C&gt;* 10.0.0.11/32 is directly connected, lo
B&gt;* 10.0.0.12/32 [20/0] via fe80::4638:39ff:fe00:5c, swp51, 1d01h04m
  *                     via fe80::4638:39ff:fe00:2b, swp52, 1d01h04m
B&gt;* 10.0.0.21/32 [20/0] via fe80::4638:39ff:fe00:5c, swp51, 1d01h04m
B&gt;* 10.0.0.22/32 [20/0] via fe80::4638:39ff:fe00:2b, swp52, 1d01h04m
C&gt;* 172.16.1.0/24 is directly connected, br0
B&gt;* 172.16.2.0/24 [20/0] via fe80::4638:39ff:fe00:5c, swp51, 1d01h04m
  *                      via fe80::4638:39ff:fe00:2b, swp52, 1d01h04m
C&gt;* 192.168.0.0/24 is directly connected, eth0
   
    
</code></pre>

<p>The following commands show how the IPv4 link-local address
<em>169.254.0.1</em> is used to install the route and static neighbor entry to
facilitate proper forwarding without having to install an IPv4 prefix
with IPv6 next-hop in the kernel:</p>

<pre><code>                   
cumulus@switch:~$ net show route 10.0.0.12
RIB entry for 10.0.0.12
=======================
Routing entry for 10.0.0.12/32
  Known via &quot;bgp&quot;, distance 20, metric 0, best
  Last update 1d01h06m ago
  * fe80::4638:39ff:fe00:5c, via swp51
  * fe80::4638:39ff:fe00:2b, via swp52
 
FIB entry for 10.0.0.12
=======================
10.0.0.12  proto zebra  metric 20 
    nexthop via 169.254.0.1  dev swp51 weight 1 onlink
    nexthop via 169.254.0.1  dev swp52 weight 1 onlink
   
    
</code></pre>

<p>You can use this <code>iproute2</code> command to display more neighbor
information:</p>

<pre><code>                   
cumulus@switch:~$ ip neighbor
192.168.0.254 dev eth0 lladdr 44:38:39:00:00:5f REACHABLE
169.254.0.1 dev swp52 lladdr 44:38:39:00:00:2b PERMANENT
169.254.0.1 dev swp51 lladdr 44:38:39:00:00:5c PERMANENT
fe80::4638:39ff:fe00:2b dev swp52 lladdr 44:38:39:00:00:2b router REACHABLE
fe80::4638:39ff:fe00:5c dev swp51 lladdr 44:38:39:00:00:5c router REACHABLE
   
    
</code></pre>

<h3 id="how-traceroute-interacts-with-bgp-unnumbered-interfaces">How traceroute Interacts with BGP Unnumbered Interfaces</h3>

<p>Every router or end host must have an IPv4 address to complete a
<code>traceroute</code> of IPv4 addresses. In this case, the IPv4 address used is
that of the loopback device.</p>

<p>Even if ENHE is not used in the data center, link addresses are not
typically advertised. This is because:</p>

<ul>
<li><p>Link addresses take up valuable FIB resources. In a large Clos
environment, the number of such addresses can be quite large.</p></li>

<li><p>Link addresses expose an additional attack vector for intruders to
use to either break in or engage in DDOS attacks.</p></li>
</ul>

<p>Assigning an IP address to the loopback device is essential.</p>

<h3 id="advanced-understanding-how-next-hop-fields-are-set">Advanced: Understanding How Next-hop Fields Are Set</h3>

<p>This section describes how the IPv6 next-hops are set in the
MP_REACH_NLRI (<a href="https://www.ietf.org/rfc/rfc2858.txt" target="_blank">multiprotocol reachable
NLRI</a>) initiated by the system,
which applies whether IPv6 prefixes or IPv4 prefixes are exchanged with
ENHE. There are two main aspects to determine — how many IPv6 next-hops
are included in the MP_REACH_NLRI (since the RFC allows either one or
two next-hops) and the values of the next-hop(s). This section also
describes how a received MP_REACH_NLRI is handled as far as processing
IPv6 next-hops.</p>

<ul>
<li><p>Whether peering to a global IPv6 address or link-local IPv6 address,
the determination whether to send one or two next-hops is as
follows:</p>

<ol>
<li><p>If reflecting the route, two next-hops are sent only if the peer
has <code>nexthop-local unchanged</code> configured and the attribute of
the received route has an IPv6 link-local next-hop; otherwise,
only one next-hop is sent.</p></li>

<li><p>Otherwise (if it is not reflecting the route), two next-hops are
sent if explicitly configured (<code>nexthop-local unchanged</code>) or the
peer is directly connected (that is, either peering is on
link-local address or the global IPv4 or IPv6 address is
<em>directly connected</em>) and the route is either a
local/self-originated route or the peer is an eBGP peer.</p></li>

<li><p>In all other cases, only one next-hop gets sent, unless an
outbound route map adds another next-hop.</p></li>
</ol></li>

<li><p><code>route-map</code> can impose two next-hops in scenarios where Cumulus
Linux only sends one next-hop — by specifying <code>set ipv6 nexthop
link-local</code>.</p></li>

<li><p>For all routes to eBGP peers and self-originated routes to iBGP
peers, the global next-hop (first value) is the peering address of
the local system. If the peering is on the link-local address, this
is the global IPv6 address on the peering interface, if present;
otherwise, it is the link-local IPv6 address on the peering
interface.</p></li>

<li><p>For other routes to iBGP peers (eBGP to iBGP or reflected), the
global next-hop will be the global next-hop in the received
attribute.</p>


<div class="notices note" > <pre><code>If this address were a link-local IPv6 address, it would get reset
so that the link-local IPv6 address of the eBGP peer is not passed
along to an iBGP peer, which most likely may be on a different link.
</code></pre>
 </div>
</li>

<li><p><code>route-map</code> and/or the peer configuration can change the above
behavior. For example, <code>route-map</code> can set the global IPv6 next-hop
or the peer configuration can set it to <em>self</em> — which is relevant
for <em>iBGP</em> peers. The route map or peer configuration can also set
the next-hop to unchanged, which ensures the source IPv6 global
next-hop is passed around — which is relevant for <em>eBGP</em> peers.</p></li>

<li><p>Whenever two next-hops are being sent, the link-local next-hop (the
second value of the two) is the link-local IPv6 address on the
peering interface unless it is due to <code>nh-local-unchanged</code> or
<code>route-map</code> has set the link-local next-hop.</p></li>

<li><p>Network administrators cannot set <a href="http://en.wikipedia.org/wiki/Martian_packet" target="_blank">martian
values</a> for IPv6
next-hops in <code>route-map</code>. Also, global and link-local next-hops are
validated to ensure they match the respective address types.</p></li>

<li><p>In a received update, a martian check is imposed for the IPv6 global
next-hop. If the check fails, it gets treated as an implicit
withdraw.</p></li>

<li><p>If two next-hops are received in an update and the second next-hop
is not a link-local address, it gets ignored and the update is
treated as if only one next-hop was received.</p></li>

<li><p>Whenever two next-hops are received in an update, the second
next-hop is used to install the route into <code>zebra</code>. As per the
previous point, it is already assured that this is a link-local IPv6
address. Currently, this is assumed to be reachable and is not
registered with NHT.</p></li>

<li><p>When <code>route-map</code> specifies the next-hop as <code>peer-address</code>, the
global IPv6 next-hop as well as the link-local IPv6 next-hop (if
it&rsquo;s being sent) is set to the <em>peering address</em>. If the peering is
on a link-local address, the former could be the link-local address
on the peering interface, unless there is a global IPv6 address
present on this interface.</p></li>

<li><p>When using iBGP unnumbered with IPv6 Link Local Addresses (the
default), FRR rewrites the BGP next hop to be the adjacent link.
This is similar behavior to eBGP next hops. However, iBGP route
advertisement rules do not change and a full mesh or route
reflectors is still required.</p></li>
</ul>

<p>The above rules imply that there are scenarios where a generated update
has two IPv6 next-hops, and both of them are the IPv6 link-local address
of the peering interface on the local system. If you are peering with a
switch or router that is not running Cumulus Linux and expects the first
next-hop to be a global IPv6 address, a route map can be used on the
sender to specify a global IPv6 address. This conforms with the
recommendations in the Internet draft
<a href="https://tools.ietf.org/html/draft-kato-bgp-ipv6-link-local-00" target="_blank">draft-kato-bgp-ipv6-link-local-00.txt</a>,
&ldquo;BGP4+ Peering Using IPv6 Link-local Address&rdquo;.</p>

<h3 id="limitations">Limitations</h3>

<ul>
<li><p>Interface-based peering with separate IPv4 and IPv6 sessions is not
supported.</p></li>

<li><p>ENHE is sent for IPv6 link-local peerings only.</p></li>

<li><p>If an IPv4 /30 or /31 IP address is assigned to the interface, IPv4
peering is used over IPv6 link-local peering.</p></li>

<li><p>If the default router lifetime in the generated IPv6 route
advertisements (RA) is set to <em>0</em>, the receiving FRRouting instance
drops the RA if it is on a Cumulus Linux <strong>2.5.z</strong> switch. To work
around this issue, either:</p>

<ul>
<li><p>Explicitly configure the switch to advertise a router lifetime
of 0, unless a value is specifically set by the operator — with
the assumption that the host is running Cumulus Linux 3.y.z
version of FRRouting. When hosts see an IPv6 RA with a router
lifetime of 0, they do not make that router a default router.</p></li>

<li><p>Use the <code>sysctl</code> on the host —
<code>net.ipv6.conf.all.accept_ra_defrtr</code>. However, this requires
applying this setting on all hosts, which might mean many hosts,
especially if FRRouting is run on the hosts.</p></li>
</ul></li>
</ul>

<h2 id="bgp-add-path">BGP add-path</h2>

<h3 id="bgp-add-path-rx">BGP add-path RX</h3>

<p><em>BGP add-path RX</em> allows BGP to receive multiple paths for the same
prefix. A path identifier is used so that additional paths do not
override previously advertised paths. No additional configuration is
required for BGP add-path RX.</p>


<div class="notices note" > <p>BGP advertises the add-path RX capability by default. Add-Path TX
requires an administrator to enable it. Enabling TX resets the session.</p>
 </div>


<p>To view the existing capabilities, run <code>net show bgp neighbor</code>. The
existing capabilities are listed in the subsection <em>Add Path</em>, below
<em>Neighbor capabilities:</em></p>

<pre><code>                   
cumulus@leaf01:~$ net show bgp neighbor 
BGP neighbor on swp51: fe80::4638:39ff:fe00:5c, remote AS 65020, local AS 65011, external link
Hostname: spine01
 Member of peer-group fabric for session parameters
  BGP version 4, remote router ID 10.0.0.21
  BGP state = Established, up for 1d01h15m
  Last read 00:00:00, Last write 1d01h15m
  Hold time is 3, keepalive interval is 1 seconds
  Configured hold time is 3, keepalive interval is 1 seconds
  Neighbor capabilities:
    4 Byte AS: advertised and received
    AddPath:
      IPv4 Unicast: RX advertised IPv4 Unicast and received
    Extended nexthop: advertised and received
      Address families by peer:
                   IPv4 Unicast
    Route refresh: advertised and received(old &amp; new)
    Address family IPv4 Unicast: advertised and received
    Hostname Capability: advertised and received
    Graceful Restart Capabilty: advertised and received
      Remote Restart timer is 120 seconds
      Address families by peer:
        none
 
...
   
    
</code></pre>

<p>The example output above shows that additional BGP paths can be sent and
received (TX and RX are advertised). It also shows that the BGP
neighbor, fe80::4638:39ff:fe00:5c, supports both.</p>

<p>To view the current additional paths, run <code>net show bgp &lt;network&gt;</code>. The
example output shows an additional path that has been added by the TX
node for receiving. Each path has a unique AddPath ID.</p>

<pre><code>                   
cumulus@leaf01:~$ net show bgp 10.0.0.12
BGP routing table entry for 10.0.0.12/32
Paths: (2 available, best #1, table Default-IP-Routing-Table)
  Advertised to non peer-group peers:
  spine01(swp51) spine02(swp52)
  65020 65012
    fe80::4638:39ff:fe00:5c from spine01(swp51) (10.0.0.21)
    (fe80::4638:39ff:fe00:5c) (used)
      Origin incomplete, localpref 100, valid, external, multipath, bestpath-from-AS 65020, best
      AddPath ID: RX 0, TX 6
      Last update: Wed Nov 16 22:47:00 2016
  65020 65012
    fe80::4638:39ff:fe00:2b from spine02(swp52) (10.0.0.22)
    (fe80::4638:39ff:fe00:2b) (used)
      Origin incomplete, localpref 100, valid, external, multipath
      AddPath ID: RX 0, TX 3
      Last update: Wed Nov 16 22:47:00 2016
   
    
</code></pre>

<h3 id="bgp-add-path-tx">BGP add-path TX</h3>

<p>AddPath TX allows BGP to advertise more than just the bestpath for a
prefix. Consider the following topology:</p>

<pre><code>                   
          r8
          |
          |
  r1 ----    ---- r6
  r2 ---- r7 ---- r5
          ||
          ||
        r3 r4
   
    
</code></pre>

<p>In this topology:</p>

<ul>
<li><p>r1 and r2 are in AS 100</p></li>

<li><p>r3 and r4 are in AS 300</p></li>

<li><p>r5 and r6 are in AS 500</p></li>

<li><p>r7 is in AS 700</p></li>

<li><p>r8 is in AS 800</p></li>

<li><p>r7 learns 1.1.1.<sup>1</sup>&frasl;<sub>32</sub> from r1, r2, r3, r4, r5, and r6. Among these r7
picks the path from r1 as the bestpath for 1.1.1.<sup>1</sup>&frasl;<sub>32</sub></p></li>
</ul>

<p>The example below configures the r7 session to advertise the bestpath
learned from each AS. In this case, this means a path from AS 100, a
path from AS 300, and a path from AS 500. The <code>net show bgp 1.1.1.1/32</code>
from r7 has &ldquo;bestpath-from-AS 100&rdquo; so the user can see what the bestpath
is from each AS:</p>

<pre><code>                   
cumulus@r7:~$ net add bgp autonomous-system 700
cumulus@r7:~$ net add bgp neighbor 192.0.2.2 addpath-tx-bestpath-per-AS
   
    
</code></pre>

<p>The output below shows the result on r8:</p>

<pre><code>                   
cumulus@r8:~$ net show bgp 1.1.1.1/32
BGP routing table entry for 1.1.1.1/32
Paths: (3 available, best #3, table Default-IP-Routing-Table)
  Advertised to non peer-group peers:
  r7(10.7.8.1)
  700 100
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external
      Community: 1:1
      AddPath ID: RX 2, TX 4
      Last update: Thu Jun  2 00:57:14 2016
 
  700 300
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external
      Community: 3:3
      AddPath ID: RX 4, TX 3
      Last update: Thu Jun  2 00:57:14 2016
 
  700 500
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external, bestpath-from-AS 700, best
      Community: 5:5
      AddPath ID: RX 6, TX 2
      Last update: Thu Jun  2 00:57:14 2016
   
    
</code></pre>

<p>The example below shows the results if r7 is configured to advertise all
paths to r8:</p>

<pre><code>                   
cumulus@r7:~$ net add bgp autonomous-system 700
cumulus@r7:~$ net add bgp neighbor 192.0.2.2 addpath-tx-all-paths
   
    
</code></pre>

<p>The output below shows the result on r8:</p>

<pre><code>                   
cumulus@r8:~$ net show bgp 1.1.1.1/32
BGP routing table entry for 1.1.1.1/32
Paths: (3 available, best #3, table Default-IP-Routing-Table)
  Advertised to non peer-group peers:
  r7(10.7.8.1)
  700 100
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external
      Community: 1:1
      AddPath ID: RX 2, TX 4
      Last update: Thu Jun  2 00:57:14 2016
 
  700 300
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external
      Community: 3:3
      AddPath ID: RX 4, TX 3
      Last update: Thu Jun  2 00:57:14 2016
 
  700 500
    10.7.8.1 from r7(10.7.8.1) (10.0.0.7)
      Origin IGP, localpref 100, valid, external, bestpath-from-AS 700, best
      Community: 5:5
      AddPath ID: RX 6, TX 2
      Last update: Thu Jun  2 00:57:14 2016
   
    
</code></pre>

<h2 id="fast-convergence-design-considerations">Fast Convergence Design Considerations</h2>

<p>Without getting into the why (see the IETF draft cited in Useful Links
below that talks about BGP use within the data center), we strongly
recommend the following use of addresses in the design of a BGP-based
data center network:</p>

<ul>
<li><p>Use of interface addresses: Set up BGP sessions only using
interface-scoped addresses. This allows BGP to react quickly to link
failures.</p></li>

<li><p>Use of next-hop-self: Every BGP node says that it knows how to
forward traffic to the prefixes it is announcing. This reduces the
requirement to announce interface-specific addresses and thereby
reduces the size of the forwarding table.</p></li>
</ul>

<h3 id="specifying-the-interface-name-in-the-neighbor-command">Specifying the Interface Name in the neighbor Command</h3>

<p>When you are configuring BGP for the neighbors of a given interface, you
can specify the interface name instead of its IP address. All the other
<code>neighbor</code> command options remain the same.</p>

<p>This is equivalent to BGP peering to the link-local IPv6 address of the
neighbor on the given interface. The link-local address is learned via
IPv6 neighbor discovery router advertisements.</p>

<p>Consider the following example configuration in the <code>/etc/frr/frr.conf</code>
file:</p>

<pre><code>                   
router bgp 65000
  bgp router-id 10.0.0.1
  neighbor swp1 interface
  neighbor swp1 remote-as internal
  neighbor swp1 next-hop-self
!
  address-family ipv6
  neighbor swp1 activate
  exit-address-family
   
    
</code></pre>

<p>You create the above configuration with the following NCLU commands:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp autonomous-system 65000
cumulus@switch:~$ net add bgp router-id 10.0.0.1
cumulus@switch:~$ net add bgp neighbor swp1 interface
cumulus@switch:~$ net add bgp neighbor swp1 remote-as internal
cumulus@switch:~$ net add bgp neighbor swp1 next-hop-self
cumulus@switch:~$ net add bgp ipv6 unicast neighbor swp1 activate
   
    
</code></pre>


<div class="notices note" > <p>By default, Cumulus Linux sends IPv6 neighbor discovery router
advertisements. Cumulus Networks recommends you adjust the interval of
the router advertisement to a shorter value (<code>net add interface
&lt;interface&gt; ipv6 nd ra-interval &lt;interval&gt;</code>) to address scenarios when
nodes come up and miss router advertisement processing to relay the
neighbor’s link-local address to BGP. The <code>interval</code> is measured in
seconds and defaults to 10 seconds.</p>
 </div>


<h2 id="using-peer-groups-to-simplify-configuration">Using Peer Groups to Simplify Configuration</h2>

<p>When there are many peers to connect to, the amount of redundant
configuration becomes overwhelming. For example, repeating the
<code>activate</code> and <code>next-hop-self</code> commands for even 60 neighbors makes for
a very long configuration file. Using <code>peer-group</code> addresses this
problem.</p>

<p>Instead of specifying properties of each individual peer, FRRouting
allows for defining one or more peer groups and associating all the
attributes common to that peer session to a peer group. A peer needs to
be attached to a peer group only once, when it then inherits all address
families activated for that peer group.</p>

<p>After doing this, the only task is to associate an IP address with a
peer group. Here is an example of defining and using peer groups:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp neighbor tier-2 peer-group
cumulus@switch:~$ net add bgp ipv4 unicast
cumulus@switch:~$ net add bgp neighbor tier-2 activate
cumulus@switch:~$ net add bgp neighbor tier-2 next-hop-self
cumulus@switch:~$ net add bgp neighbor 10.0.0.2 peer-group tier-2
cumulus@switch:~$ net add bgp neighbor 192.0.2.2 peer-group tier-2
   
    
</code></pre>


<div class="notices note" > <p>BGP peer-group restrictions have been replaced with update-groups, which
dynamically examine all peers and group them if they have the same
outbound policy.</p>
 </div>


<h2 id="configuring-bgp-dynamic-neighbors">Configuring BGP Dynamic Neighbors</h2>

<p>The <em>BGP dynamic neighbor</em> feature provides BGP peering to a group of
remote neighbors within a specified range of IPv4 or IPv6 addresses for
a BGP peer group. You can configure each range as a subnet IP address.</p>

<p>You configure dynamic neighbors using the <code>bgp listen range &lt;IP address&gt;
peer-group &lt;GROUP&gt;</code> command. After you configure the dynamic neighbors,
a BGP speaker can listen for and form peer relationships with any
neighbor in the IP address range and mapped to a peer group.</p>

<pre><code>                   
cumulus@switch:~$ net add bgp autonomous-system 65001
cumulus@switch:~$ net add bgp listen range 10.1.1.0/24 peer-group SPINE
   
    
</code></pre>

<p>You can limit the number of dynamic peers by specifying that limit in
the <code>bgp listen limit</code> command (the default value is <em>100</em>):</p>

<pre><code>                   
cumulus@switch:~$ net add bgp listen limit 5
   
    
</code></pre>

<p>Collectively, a sample configuration for IPv4 looks like this:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp autonomous-system 65001
cumulus@switch:~$ net add bgp neighbor SPINE peer-group
cumulus@switch:~$ net add bgp neighbor SPINE remote-as 65000
cumulus@switch:~$ net add bgp listen limit 5
cumulus@switch:~$ net add bgp listen range 10.1.1.0/24 peer-group SPINE
   
    
</code></pre>

<p>These commands produce an IPv4 configuration that looks like this:</p>

<pre><code>                   
router bgp 65001 
 neighbor SPINE peer-group
 neighbor SPINE remote-as 65000
  bgp listen limit 5
  bgp listen range 10.1.1.0/24 peer-group SPINE
   
    
</code></pre>

<h2 id="configuring-bgp-peering-relationships-across-switches">Configuring BGP Peering Relationships across Switches</h2>

<p>A BGP peering relationship is typically initiated with the <code>neighbor
x.x.x.x remote-as [internal|external]</code> command.</p>

<p>Specifying <em>internal</em> signifies an iBGP peering; that is, the neighbor
only creates or accepts a connection with the specified neighbor if the
remote peer AS number matches this BGP AS number.</p>

<p>Specifying <em>external</em> signifies an eBGP peering; that is, the neighbor
will only create a connection with the neighbor if the remote peer AS
number does <strong>not</strong> match this BGP AS number.</p>

<p>You can make this distinction using the <code>neighbor</code> command or the
<code>peer-group</code> command.</p>

<p>In general, use the following syntax with the <code>neighbor</code> command:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp neighbor [||] remote-as [|internal|external]
   
    
</code></pre>

<p>Some example configurations follow.</p>


<div class="notices info"  id="has" > <p>To connect to <strong>the same AS</strong> using the <code>neighbor</code> command, modify your
configuration similar to the following:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp autonomous-system 500
cumulus@switch:~$ net add bgp neighbor 192.168.1.2 remote-as internal
   
    
</code></pre>

<p>These commands create the following configuration snippet:</p>

<pre><code>                   
router bgp 500
neighbor 192.168.1.2 remote-as internal
   
    
</code></pre>
 </div>



<div class="notices info"  id="has" > <p>To connect to a <strong>different AS</strong> using the <code>neighbor</code> command, modify
your configuration similar to the following:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp autonomous-system 500
cumulus@switch:~$ net add bgp neighbor 192.168.1.2 remote-as external
   
    
</code></pre>

<p>These commands create the following configuration snippet:</p>

<pre><code>                   
router bgp 500
neighbor 192.168.1.2 remote-as external
   
    
</code></pre>
 </div>



<div class="notices info"  id="has" > <p>To connect to <strong>the same AS</strong> using the <code>peer-group</code> command, modify
your configuration similar to the following:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp autonomous-system 500
cumulus@switch:~$ net add bgp neighbor swp1 interface
cumulus@switch:~$ net add bgp neighbor IBGP peer-group
cumulus@switch:~$ net add bgp neighbor IBGP remote-as internal
cumulus@switch:~$ net add bgp neighbor swp1 interface peer-group IBGP
cumulus@switch:~$ net add bgp neighbor 192.0.2.3 peer-group IBGP
cumulus@switch:~$ net add bgp neighbor 192.0.2.4 peer-group IBGP
   
    
</code></pre>

<p>These commands create the following configuration snippet:</p>

<pre><code>                   
router bgp 500
neighbor swp1 interface
neighbor IBGP peer-group
neighbor IBGP remote-as internal
neighbor swp1 peer-group IBGP
neighbor 192.0.2.3 peer-group IBGP
neighbor 192.0.2.4 peer-group IBGP
   
    
</code></pre>
 </div>



<div class="notices info"  id="has" > <p>To connect to a <strong>different AS</strong> using the <code>peer-group</code> command, modify
your configuration similar to the following:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp autonomous-system 500
cumulus@switch:~$ net add bgp neighbor swp2 interface
cumulus@switch:~$ net add bgp neighbor EBGP peer-group
cumulus@switch:~$ net add bgp neighbor EBGP remote-as external
cumulus@switch:~$ net add bgp neighbor 192.0.2.2 peer-group EBGP
cumulus@switch:~$ net add bgp neighbor swp2 interface peer-group EBGP
cumulus@switch:~$ net add bgp neighbor 192.0.2.4 peer-group EBGP
   
    
</code></pre>

<p>These commands create the following configuration snippet:</p>

<pre><code>                   
router bgp 500
neighbor swp2 interface
neighbor EBGP peer-group
neighbor EBGP remote-as external
neighbor 192.0.2.2 peer-group EBGP
neighbor swp2 peer-group EBGP
neighbor 192.0.2.4 peer-group EBGP
   
    
</code></pre>
 </div>


<h2 id="configuring-md5-enabled-bgp-neighbors">Configuring MD5-enabled BGP Neighbors</h2>

<p>The following sections outline how to configure an MD5-enabled BGP
neighbor. Each process assumes that FRRouting is used as the routing
platform, and consists of two switches (<code>AS 65011</code> and <code>AS 65020</code>),
connected by the link 10.0.0.<sup>100</sup>&frasl;<sub>30</sub>, with the following configurations:</p>

<pre><code>                    switch1
                   
cumulus@leaf01:~$ net show bgp summary 
show bgp ipv4 unicast summary
=============================
BGP router identifier 10.0.0.11, local AS number 65011 vrf-id 0
BGP table version 6
RIB entries 11, using 1320 bytes of memory
Peers 2, using 36 KiB of memory
Peer groups 1, using 56 bytes of memory
Neighbor        V         AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
spine01(swp51)  4 65020   93587   93587        0    0    0 1d02h00m        3
spine02(swp52)  4 65020   93587   93587        0    0    0 1d02h00m        3
Total number of neighbors 2
 
show bgp ipv6 unicast summary
=============================
No IPv6 neighbor is configured
   
    
</code></pre>

<pre><code>                    switch2
                   
cumulus@spine01:~$ net show bgp summary 
show bgp ipv4 unicast summary
=============================
BGP router identifier 10.0.0.21, local AS number 65020 vrf-id 0
BGP table version 5
RIB entries 9, using 1080 bytes of memory
Peers 4, using 73 KiB of memory
Peer groups 1, using 56 bytes of memory
Neighbor        V         AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
leaf01(swp1)    4 65011     782     782        0    0    0 00:12:54        2
leaf02(swp2)    4 65012     781     781        0    0    0 00:12:53        2
swp3            4     0       0       0        0    0    0 never    Idle       
swp4            4     0       0       0        0    0    0 never    Idle       
Total number of neighbors 4
 
show bgp ipv6 unicast summary
=============================
No IPv6 neighbor is configured
 
   
    
</code></pre>

<h3 id="manually-configuring-an-md5-enabled-bgp-neighbor">Manually Configuring an MD5-enabled BGP Neighbor</h3>

<ol>
<li><p>SSH into leaf01.</p></li>

<li><p>Configure the password for the neighbor:</p>

<pre><code>                       
cumulus@leaf01:~$ net add bgp neighbor 10.0.0.102 password mypassword
       
        
</code></pre></li>

<li><p>Confirm the configuration has been implemented with the <code>net show
bgp summary</code> command:</p>

<pre><code>                       
cumulus@leaf01:~$ net show bgp summary 
show bgp ipv4 unicast summary
=============================
BGP router identifier 10.0.0.11, local AS number 65011 vrf-id 0
BGP table version 18
RIB entries 11, using 1320 bytes of memory
Peers 2, using 36 KiB of memory
Peer groups 1, using 56 bytes of memory
Neighbor        V         AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
spine01(swp51)  4 65020   96144   96146        0    0    0 00:30:29        3
spine02(swp52)  4 65020   96209   96217        0    0    0 1d02h44m        3
Total number of neighbors 2
 
show bgp ipv6 unicast summary
=============================
No IPv6 neighbor is configured
       
        
</code></pre></li>

<li><p>SSH into spine01.</p></li>

<li><p>Configure the password for the neighbor:</p>

<pre><code>                       
cumulus@spine01:~$ net add bgp neighbor 10.0.0.101 password mypassword
       
        
</code></pre></li>

<li><p>Confirm the configuration has been implemented with the <code>net show
bgp summary</code> command:</p>

<pre><code>                       
cumulus@spine01:~$ net show bgp summary 
show bgp ipv4 unicast summary
=============================
BGP router identifier 10.0.0.21, local AS number 65020 vrf-id 0
BGP table version 5
RIB entries 9, using 1080 bytes of memory
Peers 4, using 73 KiB of memory
Peer groups 1, using 56 bytes of memory
Neighbor        V         AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
leaf01(swp1)    4 65011     782     782        0    0    0 00:12:54        2
leaf02(swp2)    4 65012     781     781        0    0    0 00:12:53        2
swp3            4     0       0       0        0    0    0 never    Idle       
swp4            4     0       0       0        0    0    0 never    Idle       
Total number of neighbors 4
 
show bgp ipv6 unicast summary
=============================
No IPv6 neighbor is configured
       
        
</code></pre></li>
</ol>

<h2 id="configuring-ebgp-multihop">Configuring eBGP Multihop</h2>

<p>The eBGP Multihop option lets you use BGP to exchange routes with an
external peer that is more than one hop away.</p>

<ol>
<li><p>To establish a connection between two eBGP peers that are not
directly connected:</p>

<pre><code>                       
cumulus@leaf02:mgmt-vrf:~$ net add bgp neighbor  remote-as external
cumulus@leaf02:mgmt-vrf:~$ net add bgp neighbor  ebgp-multihop
       
        
</code></pre></li>

<li><p>Confirm the configuration with the <code>net show bgp neighbor &lt;ip&gt;</code>
command:</p>

<pre><code>cumulus@leaf02:mgmt-vrf:~$ net show bgp neighbor 10.0.0.11
BGP neighbor is 10.0.0.11, remote AS 65011, local AS 65012, external link
Hostname: leaf01
  BGP version 4, remote router ID 10.0.0.11
  BGP state = Established, up for 00:02:54
  Last read 00:00:00, Last write 00:00:00
  Hold time is 9, keepalive interval is 3 seconds
  Neighbor capabilities:
    4 Byte AS: advertised and received
    AddPath:
      IPv4 Unicast: RX advertised IPv4 Unicast and received
    Route refresh: advertised and received(old &amp; new)
    Address Family IPv4 Unicast: advertised and received
    Hostname Capability: advertised (name: leaf02,domain name: n/a) received (name: leaf01,domain name: n/a)
    Graceful Restart Capability: advertised and received
      Remote Restart timer is 120 seconds
      Address families by peer:
        none
  Graceful restart informations:
    End-of-RIB send: IPv4 Unicast
    End-of-RIB received: IPv4 Unicast
  Message statistics:
    Inq depth is 0
    Outq depth is 0
                         Sent       Rcvd
    Opens:                  1          1
    Notifications:          0          0
    Updates:             2868       2872
    Keepalives:            60         60
    Route Refresh:          0          0
    Capability:             0          0
    Total:               2929       2933
  Minimum time between advertisement runs is 0 seconds
 For address family: IPv4 Unicast
  Update group 2, subgroup 4
  Packet Queue length 0
  Community attribute sent to this neighbor(all)
  9 accepted prefixes
  Connections established 1; dropped 0
  Last reset never    
External BGP neighbor may be up to 255 hops away.    
Local host: 10.0.0.12, Local port: 40135
Foreign host: 10.0.0.11, Foreign port: 179
Nexthop: 10.0.0.12
Nexthop global: ::
Nexthop local: ::
BGP connection: non shared network
BGP Connect Retry Timer in Seconds: 10
Estimated round trip time: 1 ms
Read thread: on  Write thread: on
</code></pre></li>
</ol>

<h2 id="configuring-bgp-ttl-security">Configuring BGP TTL Security</h2>

<p>The steps below cover how to configure BGP ttl security on Cumulus
Linux, using a leaf (<code>leaf01</code>), and spine (<code>spine01</code>) for the example
output:</p>

<ol>
<li><p>SSH into leaf01 and configure it for TTL security:</p>

<pre><code>                       
cumulus@leaf01:~$ net add bgp autonomous-system 65000
cumulus@leaf01:~$ net add bgp neighbor [spine01-IP] ttl-security hops [value]
       
        
</code></pre></li>

<li><p>SSH into spine01 and configure it for TTL security:</p>

<pre><code>                       
cumulus@spine01:~$ net add bgp autonomous-system 65001
cumulus@spine01:~$ net add bgp neighbor [leaf01-IP] ttl-security hops [value]
       
        
</code></pre></li>

<li><p>Confirm the configuration with the <code>show ip bgp neighbor</code> command:</p>

<pre><code>cumulus@spine01:mgmt-vrf:~$ net show bgp neighbor swp1
BGP neighbor on swp1: fe80::4638:39ff:fe00:5b, remote AS 65011, local AS 65020, external link
Hostname: leaf01
  BGP version 4, remote router ID 10.0.0.11
  BGP state = Established, up for 00:10:45
  Last read 00:00:03, Last write 00:00:03
  Hold time is 9, keepalive interval is 3 seconds
  Neighbor capabilities:
    4 Byte AS: advertised and received
    AddPath:
      IPv4 Unicast: RX advertised IPv4 Unicast and received
    Extended nexthop: advertised and received
      Address families by peer:
                   IPv4 Unicast
    Route refresh: advertised and received(old &amp; new)
    Address Family IPv4 Unicast: advertised and received
    Hostname Capability: advertised (name: spine01,domain name: n/a) received (name: leaf01,domain name: n/a)
    Graceful Restart Capabilty: advertised and received
      Remote Restart timer is 120 seconds
      Address families by peer:
        none
  Graceful restart informations:
    End-of-RIB send: IPv4 Unicast
    End-of-RIB received: IPv4 Unicast
  Message statistics:
    Inq depth is 0
    Outq depth is 0
                         Sent       Rcvd
    Opens:                 46          2
    Notifications:         41          0
    Updates:               38         34
    Keepalives:         49334      49331
    Route Refresh:          0          0
    Capability:             0          0
    Total:              49459      49367
  Minimum time between advertisement runs is 0 seconds

 For address family: IPv4 Unicast
  Update group 1, subgroup 1
  Packet Queue length 0
  Community attribute sent to this neighbor(all)
  3 accepted prefixes

  Connections established 2; dropped 1
  Last reset 00:17:37, due to NOTIFICATION sent (Hold Timer Expired)    
External BGP neighbor may be up to 1 hops away.    
Local host: fe80::4638:39ff:fe00:5c, Local port: 35564
Foreign host: fe80::4638:39ff:fe00:5b, Foreign port: 179
Nexthop: 10.0.0.21
Nexthop global: fe80::4638:39ff:fe00:5c
Nexthop local: fe80::4638:39ff:fe00:5c
BGP connection: shared network
BGP Connect Retry Timer in Seconds: 10
Read thread: on  Write thread: on
</code></pre></li>
</ol>

<h2 id="configuration-tips">Configuration Tips</h2>

<h3 id="bgp-advertisement-best-practices">BGP Advertisement Best Practices</h3>

<p>Limiting the exchange of routing information at various parts in the
network is a best practice you should follow. The following image
illustrates one way you can do so in a typical Clos architecture:</p>








<img class = "confluence-embedded-image" src = "/undefinedimages/download/attachments/8357722/BGP&#43;Advertisement&#43;Best&#43;Practices.png" alt = "/undefinedimages/download/attachments/8357722/BGP&#43;Advertisement&#43;Best&#43;Practices.png"

height = 400


 />


<h3 id="utilizing-multiple-routing-tables-and-forwarding">Utilizing Multiple Routing Tables and Forwarding</h3>

<p>You can run multiple routing tables (one for in-band/data plane traffic
and one for out-of-band/management plane traffic) on the same switch
using <a href="/old/Cumulus_Linux_35/Management_VRF.html">management VRF</a>
(multiple routing tables and forwarding).</p>


<div class="notices note" > <p>In Cumulus Linux 3.0 and later, BGP and static routing (IPv4 and IPv6)
are supported within a VRF context. For more information, refer to
<a href="/old/Cumulus_Linux_35/Virtual_Routing_and_Forwarding_-_VRF.html">Virtual Routing and Forwarding -
VRF</a>.</p>
 </div>


<h3 id="using-bgp-community-lists">Using BGP Community Lists</h3>

<p>You can use <a href="http://www.nongnu.org/quagga/docs/docs-multi/BGP-Community-Lists.html#BGP-Community-Lists" target="_blank"><em>community
lists</em></a>
to define a BGP community to tag one or more routes. You can then use
the communities to apply route policy on either egress or ingress.</p>

<p>The BGP community list can be either <em>standard</em> or <em>expanded.</em> The
standard BGP community list is a pair of values (such as <em>100:100</em>) that
can be tagged on a specific prefix and advertised to other neighbors or
applied on route ingress. Alternately, it can be one of four BGP default
communities:</p>

<ul>
<li><p><em>internet</em>: a BGP community that matches all routes</p></li>

<li><p><em>local-AS</em>: a BGP community that restrict routes to your
confederation&rsquo;s sub-AS</p></li>

<li><p><em>no-advertise</em>: a BGP community that isn&rsquo;t advertised to anyone</p></li>

<li><p><em>no-export</em>: a BGP community that isn&rsquo;t advertised to the eBGP peer</p></li>
</ul>

<p>An expanded BGP community list takes a regular expression of communities
matches the listed communities.</p>

<p>When the neighbor receives the prefix, it examines the community value
and takes action accordingly, such as permitting or denying the
community member in the routing policy.</p>

<p>Here&rsquo;s an example of standard community list filter:</p>

<pre><code>                   
cumulus@switch:~$ net add routing community-list standard COMMUNITY1 permit 100:100
   
    
</code></pre>

<p>You can apply the community list to a route map to define the routing
policy:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp table-map ROUTE-MAP1
   
    
</code></pre>

<h3 id="additional-default-settings">Additional Default Settings</h3>

<p>Other default settings not discussed in detail in this chapter include
the following; they&rsquo;re all enabled by default:</p>

<ul>
<li><p><code>bgp deterministic-med</code>, which ensures path ordering no longer
impacts bestpath selection.</p></li>

<li><p><code>bgp show-hostname</code>, which displays the hostname in show command
output.</p></li>

<li><p><code>bgp network import-check</code>, which enables the advertising of the BGP
network in IGP.</p></li>
</ul>

<h3 id="configuring-bgp-neighbor-maximum-prefixes">Configuring BGP Neighbor maximum-prefixes</h3>

<p>The maximum number of route announcements, or prefixes, allowed by a BGP
neighbor can be configured using the <code>maximum-prefixes</code> command in the
CLI. Replace the <code>PEER</code> input with the relevant peer, and replace
<code>NUMBER</code> with the maximum number of prefixes desired:</p>

<pre><code>                   
frr(config)# neighbor PEER maximum-prefix NUMBER
   
    
</code></pre>

<h2 id="troubleshooting-bgp">Troubleshooting BGP</h2>

<p>The most common starting point for troubleshooting BGP is to view the
summary of neighbors connected to and some information about these
connections. A sample output of this command is as follows:</p>

<pre><code>                   
cumulus@switch:~$ net show bgp summary 
show bgp ipv4 unicast summary
=============================
BGP router identifier 10.0.0.11, local AS number 65011 vrf-id 0
BGP table version 8
RIB entries 11, using 1320 bytes of memory
Peers 2, using 36 KiB of memory
Peer groups 1, using 56 bytes of memory
Neighbor        V         AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
spine01(swp51)  4 65020     549     551        0    0    0 00:09:03        3
spine02(swp52)  4 65020     548     550        0    0    0 00:09:02        3
Total number of neighbors 2
 
show bgp ipv6 unicast summary
=============================
No IPv6 neighbor is configured
   
    
</code></pre>


<div class="notices tip" > <p>You can determine whether the sessions above are iBGP or eBGP sessions
by looking at the ASNs.</p>
 </div>


<p>It is also useful to view the routing table as defined by BGP:</p>

<pre><code>                   
cumulus@switch:~$ net show bgp ipv4
ERROR: Command not found
Use 'net help KEYWORD(s)' to list all options that use KEYWORD(s)
cumulus@leaf01:~$ net show bgp ipv4 
    unicast  :  add help text
cumulus@leaf01:~$ net show bgp ipv4 unicast 
BGP table version is 8, local router ID is 10.0.0.11
Status codes: s suppressed, d damped, h history, * valid, &gt; best, = multipath,
              i internal, r RIB-failure, S Stale, R Removed
Origin codes: i - IGP, e - EGP, ? - incomplete
   Network          Next Hop            Metric LocPrf Weight Path
*&gt; 10.0.0.11/32     0.0.0.0                  0         32768 ?
*= 10.0.0.12/32     swp52                         0 65020 65012 ?
*&gt;                  swp51                         0 65020 65012 ?
*&gt; 10.0.0.21/32     swp51           0             0 65020 ?
*&gt; 10.0.0.22/32     swp52           0             0 65020 ?
*&gt; 172.16.1.0/24    0.0.0.0                  0         32768 i
*= 172.16.2.0/24    swp52                         0 65020 65012 i
*&gt;                  swp51                         0 65020 65012 i
Total number of prefixes 6
   
    
</code></pre>

<p>A more detailed breakdown of a specific neighbor can be obtained using
<code>net show bgp neighbor &lt;neighbor&gt;</code>:</p>

<pre><code>                   
cumulus@switch:~$ net show bgp neighbor swp51
BGP neighbor on swp51: fe80::4638:39ff:fe00:5c, remote AS 65020, local AS 65011, external link
Hostname: spine01
 Member of peer-group fabric for session parameters
  BGP version 4, remote router ID 10.0.0.21
  BGP state = Established, up for 00:11:30
  Last read 00:00:00, Last write 00:11:26
  Hold time is 3, keepalive interval is 1 seconds
  Configured hold time is 3, keepalive interval is 1 seconds
  Neighbor capabilities:
    4 Byte AS: advertised and received
    AddPath:
      IPv4 Unicast: RX advertised IPv4 Unicast and received
    Extended nexthop: advertised and received
      Address families by peer:
                   IPv4 Unicast
    Route refresh: advertised and received(old &amp; new)
    Address family IPv4 Unicast: advertised and received
    Hostname Capability: advertised and received
    Graceful Restart Capabilty: advertised and received
      Remote Restart timer is 120 seconds
      Address families by peer:
        none
  Graceful restart informations:
    End-of-RIB send: IPv4 Unicast
    End-of-RIB received: IPv4 Unicast
  Message statistics:
    Inq depth is 0
    Outq depth is 0
                         Sent       Rcvd
    Opens:                  1          1
    Notifications:          0          0
    Updates:                7          6
    Keepalives:           690        689
    Route Refresh:          0          0
    Capability:             0          0
    Total:                698        696
  Minimum time between advertisement runs is 0 seconds
 For address family: IPv4 Unicast
  fabric peer-group member
  Update group 1, subgroup 1
  Packet Queue length 0
  Community attribute sent to this neighbor(both)
  Inbound path policy configured
  Outbound path policy configured
  Incoming update prefix filter list is *dc-leaf-in
  Outgoing update prefix filter list is *dc-leaf-out
  3 accepted prefixes
  Connections established 1; dropped 0
  Last reset never
Local host: fe80::4638:39ff:fe00:5b, Local port: 48424
Foreign host: fe80::4638:39ff:fe00:5c, Foreign port: 179
Nexthop: 10.0.0.11
Nexthop global: fe80::4638:39ff:fe00:5b
Nexthop local: fe80::4638:39ff:fe00:5b
BGP connection: shared network
BGP Connect Retry Timer in Seconds: 3
Estimated round trip time: 3 ms
Read thread: on  Write thread: off
   
    
</code></pre>

<p>To see the details of a specific route such as from whom it was
received, to whom it was sent, and so forth, use the <code>net show bgp &lt;ip
address/prefix&gt;</code> command:</p>

<pre><code>                   
cumulus@leaf01:~$ net show bgp 10.0.0.11/32
BGP routing table entry for 10.0.0.11/32
Paths: (1 available, best #1, table Default-IP-Routing-Table)
  Advertised to non peer-group peers:
  spine01(swp51) spine02(swp52)
  Local
    0.0.0.0 from 0.0.0.0 (10.0.0.11)
      Origin incomplete, metric 0, localpref 100, weight 32768, valid, sourced, bestpath-from-AS Local, best
      AddPath ID: RX 0, TX 9
      Last update: Fri Nov 18 01:48:17 2016
   
    
</code></pre>

<p>This shows that the routing table prefix seen by BGP is 10.0.0.<sup>11</sup>&frasl;<sub>32</sub>,
that this route was advertised to two neighbors, and that it was not
heard by any neighbors.</p>

<h3 id="debugging-tip-logging-neighbor-state-changes">Debugging Tip: Logging Neighbor State Changes</h3>

<p>It is very useful to log the changes that a neighbor goes through to
troubleshoot any issues associated with that neighbor. This is done
using the <code>log-neighbor-changes</code> command, which is enabled by default.</p>

<p>The output is sent to the specified log file, usually
<code>/var/log/frr/bgpd.log</code>, and looks like this:</p>

<pre><code>                   
2016/07/08 10:12:06.572827 BGP: %NOTIFICATION: sent to neighbor 10.0.0.2 6/3 (Cease/Peer Unconfigured) 0 bytes
2016/07/08 10:12:06.572954 BGP: Notification sent to neighbor 10.0.0.2: type 6/3
2016/07/08 10:12:16.682071 BGP: %ADJCHANGE: neighbor 192.0.2.2 Up
2016/07/08 10:12:16.682660 BGP: %ADJCHANGE: neighbor 10.0.0.2 Up
   
    
</code></pre>

<h3 id="troubleshooting-link-local-addresses">Troubleshooting Link-local Addresses</h3>

<p>To verify that <code>frr</code> learned the neighboring link-local IPv6 address via
the IPv6 neighbor discovery router advertisements on a given interface,
use the <code>show interface &lt;if-name&gt;</code> command. If <code>ipv6 nd suppress-ra</code>
isn&rsquo;t enabled on both ends of the interface, then <code>Neighbor address(s):</code>
should have the other end&rsquo;s link-local address. That is the address that
BGP would use when BGP is enabled on that interface.</p>


<div class="notices note" > <p>IPv6 route advertisements (RAs) are automatically enabled on an
interface with IPv6 addresses, so the step <code>no ipv6 nd suppress-ra</code> is
no longer needed for BGP unnumbered.</p>
 </div>


<p>Use <code>vtysh</code> to verify the configuration:</p>

<pre><code>                   
cumulus@switch:~$ sudo vtysh
 
Hello, this is Quagga (version 0.99.23.1+cl3u2).
Copyright 1996-2005 Kunihiro Ishiguro, et al.
 
R7# show interface swp1
Interface swp1 is up, line protocol is up
  Link ups:       0    last: (never)
  Link downs:     0    last: (never)
  PTM status: disabled
  vrf: Default-IP-Routing-Table
  index 4 metric 0 mtu 1500 
  flags: 
  HWaddr: 44:38:39:00:00:5c
  inet6 fe80::4638:39ff:fe00:5c/64
  ND advertised reachable time is 0 milliseconds
  ND advertised retransmit interval is 0 milliseconds
  ND router advertisements are sent every 10 seconds
  ND router advertisements lifetime tracks ra-interval
  ND router advertisement default router preference is medium
  Hosts use stateless autoconfig for addresses.
  Neighbor address(s):
  inet6 fe80::4638:39ff:fe00:5b/128
   
    
</code></pre>

<p>Instead of the IPv6 address, the peering interface name is displayed in
the <code>show ip bgp summary</code> command and wherever else applicable:</p>

<pre><code>                   
cumulus@switch:~$ net show bgp summary
BGP router identifier 10.0.0.21, local AS number 65020 vrf-id 0
BGP table version 15
RIB entries 17, using 2040 bytes of memory
Peers 6, using 97 KiB of memory
Peer groups 1, using 56 bytes of memory
 
Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
leaf01(swp1)    4 65011    2834    2843        0    0    0 02:21:35        2
leaf02(swp2)    4 65012    2834    2844        0    0    0 02:21:36        2
leaf03(swp3)    4 65013    2834    2843        0    0    0 02:21:35        2
leaf04(swp4)    4 65014    2834    2844        0    0    0 02:21:36        2
edge01(swp29)   4 65051    8509    8505        0    0    0 02:21:37        3
edge01(swp30)   4 65051    8506    8503        0    0    0 02:21:35        3
 
Total number of neighbors 6
   
    
</code></pre>

<p>Most of the show commands can take the interface name instead of the IP
address, if that level of specificity is needed:</p>

<pre><code>                   
cumulus@leaf01:~$ net show bgp neighbor 
    fabric  :  BGP neighbor or peer-group
    swp51   :  BGP neighbor or peer-group
    swp52   :  BGP neighbor or peer-group
    
   
    
</code></pre>

<pre><code>                   
cumulus@leaf01:~$ net show bgp neighbor swp51
BGP neighbor on swp51: fe80::4638:39ff:fe00:5c, remote AS 65020, local AS 65011, external link
Hostname: spine01
 Member of peer-group fabric for session parameters
  BGP version 4, remote router ID 0.0.0.0
  BGP state = Connect
  Last read 20:16:21, Last write 20:55:51
  Hold time is 30, keepalive interval is 10 seconds
  Configured hold time is 30, keepalive interval is 10 seconds
  Message statistics:
    Inq depth is 0
    Outq depth is 0
                         Sent       Rcvd
    Opens:                  1          1
    Notifications:          1          0
    Updates:                7          6
    Keepalives:          2374       2373
    Route Refresh:          0          0
    Capability:             0          0
    Total:               2383       2380
  Minimum time between advertisement runs is 5 seconds
 For address family: IPv4 Unicast
  fabric peer-group member
  Not part of any update group
  Community attribute sent to this neighbor(both)
  Inbound path policy configured
  Outbound path policy configured
  Incoming update prefix filter list is *dc-leaf-in
  Outgoing update prefix filter list is *dc-leaf-out
  0 accepted prefixes
  Connections established 1; dropped 1
  Last reset 20:16:20, due to NOTIFICATION sent (Cease/Other Configuration Change)
BGP Connect Retry Timer in Seconds: 3
Next connect timer due in 1 seconds
Read thread: on  Write thread: on
   
    
</code></pre>

<h2 id="enabling-read-only-mode">Enabling Read-only Mode</h2>

<p>You can enable read-only mode for when the BGP process restarts or when
the BGP process is cleared using <code>clear ip bgp *</code>. When enabled,
read-only mode begins as soon as the first peer reaches its
<em>established</em> state and a timer for <code>&lt;max-delay&gt;</code> seconds is started.</p>

<p>While in read-only mode, BGP doesn&rsquo;t run best-path or generate any
updates to its peers. This mode continues until:</p>

<ul>
<li><p>All the configured peers, except the shutdown peers, have sent an
explicit EOR (End-Of-RIB) or an implicit EOR. The first keep-alive
after BGP has reached the established state is considered an
implicit EOR. If the <code>&lt;establish-wait&gt;</code> option is specified, then
BGP will wait for peers to reach the established state from the
start of the <code>update-delay</code> until the <code>&lt;establish-wait&gt;</code> period is
over; that is, the minimum set of established peers for which EOR is
expected would be peers established during the <code>establish-wait</code>
window, not necessarily all the configured neighbors.</p></li>

<li><p>The <code>max-delay</code> period is over.</p></li>
</ul>

<p>Upon reaching either of these two conditions, BGP resumes the decision
process and generates updates to its peers.</p>

<p>To enable read-only mode:</p>

<pre><code>                   
cumulus@switch:$ net add bgp update-delay  []
   
    
</code></pre>

<p>The default <code>&lt;max-delay&gt;</code> is 0 — the feature is off by default.</p>

<p>Use output from <code>show ip bgp summary</code> for information about the state of
the update delay.</p>

<p>This feature can be useful in reducing CPU/network usage as BGP
restarts/clears. It&rsquo;s particularly useful in topologies where BGP learns
a prefix from many peers. Intermediate best paths are possible for the
same prefix as peers get established and start receiving updates at
different times. This feature is also valuable if the network has a high
number of such prefixes.</p>

<h2 id="applying-a-route-map-for-route-updates">Applying a Route Map for Route Updates</h2>

<p>There are two ways you can apply <a href="http://www.nongnu.org/quagga/docs/docs-multi/Route-Map.html#Route-Map" target="_blank">route
maps</a>
for BGP:</p>

<ul>
<li><p>By filtering routes from BGP into Zebra</p></li>

<li><p>By filtering routes from Zebra into the Linux kernel</p></li>
</ul>

<h3 id="filtering-routes-from-bgp-into-zebra">Filtering Routes from BGP into Zebra</h3>

<p>For the first way, you can apply a route map on route updates from BGP
to Zebra. All the applicable match operations are allowed, such as match
on prefix, next-hop, communities, and so forth. Set operations for this
attach-point are limited to metric and next-hop only. Any operation of
this feature does not affect BGPs internal RIB.</p>

<p>Both IPv4 and IPv6 address families are supported. Route maps work on
multi-paths as well. However, the metric setting is based on the best
path only.</p>

<p>To apply a route map to filter route updates from BGP into Zebra:</p>

<pre><code>                   
cumulus@switch:$ net add bgp table-map 
   
    
</code></pre>

<h3 id="filtering-routes-from-zebra-into-the-linux-kernel">Filtering Routes from Zebra into the Linux Kernel</h3>

<p>To apply a route map to filter route updates from Zebra into the Linux
kernel:</p>

<pre><code>                   
cumulus@switch:$ net add routing protocol bgp route-map 
   
    
</code></pre>

<h2 id="protocol-tuning">Protocol Tuning</h2>

<h3 id="converging-quickly-on-link-failures">Converging Quickly On Link Failures</h3>

<p>In the Clos topology, we recommend that you only use interface addresses
to set up peering sessions. This means that when the link fails, the BGP
session is torn down immediately, triggering route updates to propagate
through the network quickly. This requires the following commands be
enabled for all links: <code>link-detect</code> and <code>ttl-security hops &lt;hops&gt;</code>.
<code>ttl-security hops</code> specifies how many hops away the neighbor is. For
example, in a Clos topology, every peer is at most 1 hop away.</p>


<div class="notices note" > <p>See Caveats and Errata below for information regarding <code>ttl-security
hops</code>.</p>
 </div>


<p>Here is an example:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp neighbor 10.0.0.2 ttl-security hops 1
   
    
</code></pre>

<h3 id="converging-quickly-on-soft-failures">Converging Quickly On Soft Failures</h3>

<p>It is possible that the link is up, but the neighboring BGP process is
hung or has crashed. If a BGP process crashes, FRRouting’s <code>watchquagga</code>
daemon, which monitors the various FRRouting daemons, will attempt to
restart it. If the process is also hung, <code>watchquagga</code> will attempt to
restart the process. BGP itself has a keepalive timer that is exchanged
between neighbors. By default, this keepalive timer is set to 3 seconds.
This time can be increased to a higher number, which decreases CPU load,
especially in the presence of a lot of neighbors. <code>keepalive-time</code> is
the periodicity with which the keepalive message is sent. <code>hold-time</code>
specifies how many keepalive messages can be lost before the connection
is considered invalid. It is usually set to 3 times the keepalive time,
so it defaults to 9 seconds. Here is an example of changing these
timers:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp neighbor swp51 timers 10 30
   
    
</code></pre>

<p>The following display snippet shows that the default values have been
modified for this neighbor:</p>

<pre><code>                   
cumulus@switch:~$ net show bgp neighbor swp51 
BGP neighbor on swp51: fe80::4638:39ff:fe00:5c, remote AS 65020, local AS 65011, external link
Hostname: spine01
 Member of peer-group fabric for session parameters
  BGP version 4, remote router ID 0.0.0.0
  BGP state = Connect
  Last read 00:00:13, Last write 00:39:43
  Hold time is 30, keepalive interval is 10 seconds
  Configured hold time is 30, keepalive interval is 10 seconds
...
   
    
</code></pre>

<h3 id="reconnecting-quickly">Reconnecting Quickly</h3>

<p>A BGP process attempts to connect to a peer after a failure (or on
startup) every <code>connect-time</code> seconds. By default, this is 10 seconds.
To modify this value, use:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp neighbor swp51 timers connect 30
   
    
</code></pre>

<p>This command has to be specified per each neighbor, peer-group doesn’t
support this option in <code>frr</code>.</p>

<h3 id="advertisement-interval">Advertisement Interval</h3>

<p>BGP by default chooses stability over fast convergence. This is very
useful when routing for the Internet. For example, unlike link-state
protocols, BGP typically waits for a duration of
<code>advertisement-interval</code> seconds between sending consecutive updates to
a neighbor. This ensures that an unstable neighbor flapping routes won’t
be propagated throughout the network. By default, this is set to 0
seconds for both eBGP and iBGP sessions, which allows for very fast
convergence. You can modify this as follows:</p>

<pre><code>                   
cumulus@switch:~$ net add bgp neighbor swp51 advertisement-interval 5
   
    
</code></pre>

<p>The following output shows the modified value:</p>

<pre><code>                   
cumulus@switch:~$ net show bgp neighbor swp51 
BGP neighbor on swp51: fe80::4638:39ff:fe00:5c, remote AS 65020, local AS 65011, external link
Hostname: spine01
 Member of peer-group fabric for session parameters
  BGP version 4, remote router ID 0.0.0.0
  BGP state = Connect
  Last read 00:04:37, Last write 00:44:07
  Hold time is 30, keepalive interval is 10 seconds
  Configured hold time is 30, keepalive interval is 10 seconds
  Message statistics:
    Inq depth is 0
    Outq depth is 0
                         Sent       Rcvd
    Opens:                  1          1
    Notifications:          1          0
    Updates:                7          6
    Keepalives:          2374       2373
    Route Refresh:          0          0
    Capability:             0          0
    Total:               2383       2380
  Minimum time between advertisement runs is 5 seconds
...
   
    
</code></pre>


<div class="notices note" > <p>This command is not supported with peer-groups.</p>
 </div>


<p>See this <a href="http://tools.ietf.org/html/draft-jakma-mrai-02" target="_blank">IETF draft</a>
for more details on the use of this value.</p>

<h2 id="caveats-and-errata">Caveats and Errata</h2>

<h3 id="ttl-security-issue">ttl-security Issue</h3>

<p>Enabling <code>ttl-security</code> does not cause the hardware to be programmed
with the relevant information. This means that frames will come up to
the CPU and be dropped there. It is recommended that you use the <code>net
add acl</code> command to explicitly add the relevant entry to hardware.</p>

<p>For example, you can configure a file, like
<code>/etc/cumulus/acl/policy.d/01control_plane_bgp.rules</code>, with a rule like
this for TTL:</p>

<pre><code>                   
INGRESS_INTF = swp1 
    INGRESS_CHAIN = INPUT, FORWARD 
 
    [iptables]
    -A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p tcp --dport bgp -m ttl --ttl 255 POLICE --set-mode pkt --set-rate 2000 --set-burst 1000 
-A $INGRESS_CHAIN --in-interface $INGRESS_INTF -p tcp --dport bgp DROP
   
    
</code></pre>


<div class="notices note" > <p>For more information about ACLs, see <a href="/old/Cumulus_Linux_35/Netfilter_-_ACLs.html">Netfilter
(ACLs)</a>.</p>
 </div>


<h3 id="bgp-dynamic-capabilities-not-supported">BGP Dynamic Capabilities not Supported</h3>

<p>Dynamic capabilities, which enable BGP to renegotiate a new feature for
an already established peer, are not supported in Cumulus Linux.</p>

<h3 id="related-information">Related Information</h3>

<ul>
<li><p><a href="/old/Cumulus_Linux_35/Bidirectional_Forwarding_Detection_-_BFD.html">Bidirectional forwarding
detection</a>
(BFD) and BGP</p></li>

<li><p><a href="http://en.wikipedia.org/wiki/Border_Gateway_Protocol" target="_blank">Wikipedia entry for
BGP</a> (includes
list of useful RFCs)</p></li>

<li><p><a href="https://frrouting.org/user-guide/BGP.html#BGP" target="_blank">frrouting.org/user-guide/BGP.html#BGP</a></p></li>

<li><p><a href="http://tools.ietf.org/html/draft-lapukhov-bgp-routing-large-dc-04" target="_blank">IETF draft discussing BGP use within data
centers</a></p></li>
</ul>
</article>



    </div>
    

      


  

    <aside class="book-toc fixed">

  

  <button> </button>

      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#autonomous-system-number-asn">Autonomous System Number (ASN)</a></li>
<li><a href="#ebgp-and-ibgp">eBGP and iBGP</a></li>
<li><a href="#route-reflectors">Route Reflectors</a>
<ul>
<li><a href="#configuring-clusters">Configuring Clusters</a></li>
</ul></li>
<li><a href="#ecmp-with-bgp">ECMP with BGP</a>
<ul>
<li><a href="#maximum-paths">Maximum Paths</a></li>
<li><a href="#bgp-for-both-ipv4-and-ipv6">BGP for Both IPv4 and IPv6</a></li>
</ul></li>
<li><a href="#configuring-bgp">Configuring BGP</a></li>
<li><a href="#using-bgp-unnumbered-interfaces">Using BGP Unnumbered Interfaces</a>
<ul>
<li><a href="#bgp-and-extended-next-hop-encoding">BGP and Extended Next-hop Encoding</a></li>
<li><a href="#configuring-bgp-unnumbered-interfaces">Configuring BGP Unnumbered Interfaces</a></li>
<li><a href="#managing-unnumbered-interfaces">Managing Unnumbered Interfaces</a></li>
<li><a href="#how-traceroute-interacts-with-bgp-unnumbered-interfaces">How traceroute Interacts with BGP Unnumbered Interfaces</a></li>
<li><a href="#advanced-understanding-how-next-hop-fields-are-set">Advanced: Understanding How Next-hop Fields Are Set</a></li>
<li><a href="#limitations">Limitations</a></li>
</ul></li>
<li><a href="#bgp-add-path">BGP add-path</a>
<ul>
<li><a href="#bgp-add-path-rx">BGP add-path RX</a></li>
<li><a href="#bgp-add-path-tx">BGP add-path TX</a></li>
</ul></li>
<li><a href="#fast-convergence-design-considerations">Fast Convergence Design Considerations</a>
<ul>
<li><a href="#specifying-the-interface-name-in-the-neighbor-command">Specifying the Interface Name in the neighbor Command</a></li>
</ul></li>
<li><a href="#using-peer-groups-to-simplify-configuration">Using Peer Groups to Simplify Configuration</a></li>
<li><a href="#configuring-bgp-dynamic-neighbors">Configuring BGP Dynamic Neighbors</a></li>
<li><a href="#configuring-bgp-peering-relationships-across-switches">Configuring BGP Peering Relationships across Switches</a></li>
<li><a href="#configuring-md5-enabled-bgp-neighbors">Configuring MD5-enabled BGP Neighbors</a>
<ul>
<li><a href="#manually-configuring-an-md5-enabled-bgp-neighbor">Manually Configuring an MD5-enabled BGP Neighbor</a></li>
</ul></li>
<li><a href="#configuring-ebgp-multihop">Configuring eBGP Multihop</a></li>
<li><a href="#configuring-bgp-ttl-security">Configuring BGP TTL Security</a></li>
<li><a href="#configuration-tips">Configuration Tips</a>
<ul>
<li><a href="#bgp-advertisement-best-practices">BGP Advertisement Best Practices</a></li>
<li><a href="#utilizing-multiple-routing-tables-and-forwarding">Utilizing Multiple Routing Tables and Forwarding</a></li>
<li><a href="#using-bgp-community-lists">Using BGP Community Lists</a></li>
<li><a href="#additional-default-settings">Additional Default Settings</a></li>
<li><a href="#configuring-bgp-neighbor-maximum-prefixes">Configuring BGP Neighbor maximum-prefixes</a></li>
</ul></li>
<li><a href="#troubleshooting-bgp">Troubleshooting BGP</a>
<ul>
<li><a href="#debugging-tip-logging-neighbor-state-changes">Debugging Tip: Logging Neighbor State Changes</a></li>
<li><a href="#troubleshooting-link-local-addresses">Troubleshooting Link-local Addresses</a></li>
</ul></li>
<li><a href="#enabling-read-only-mode">Enabling Read-only Mode</a></li>
<li><a href="#applying-a-route-map-for-route-updates">Applying a Route Map for Route Updates</a>
<ul>
<li><a href="#filtering-routes-from-bgp-into-zebra">Filtering Routes from BGP into Zebra</a></li>
<li><a href="#filtering-routes-from-zebra-into-the-linux-kernel">Filtering Routes from Zebra into the Linux Kernel</a></li>
</ul></li>
<li><a href="#protocol-tuning">Protocol Tuning</a>
<ul>
<li><a href="#converging-quickly-on-link-failures">Converging Quickly On Link Failures</a></li>
<li><a href="#converging-quickly-on-soft-failures">Converging Quickly On Soft Failures</a></li>
<li><a href="#reconnecting-quickly">Reconnecting Quickly</a></li>
<li><a href="#advertisement-interval">Advertisement Interval</a></li>
</ul></li>
<li><a href="#caveats-and-errata">Caveats and Errata</a>
<ul>
<li><a href="#ttl-security-issue">ttl-security Issue</a></li>
<li><a href="#bgp-dynamic-capabilities-not-supported">BGP Dynamic Capabilities not Supported</a></li>
<li><a href="#related-information">Related Information</a></li>
</ul></li>
</ul></li>
</ul>
</nav>

      
      <button>
      <a href="https://github.com/cawleyflower/testDocs/edit/dev/content/version/Cumulus_Linux_35/Layer_3/Border_Gateway_Protocol_-_BGP.md" target="_blank" rel="noopener">
        <img src="/svg/pencil-circle.svg" alt="Edit" /> Edit this page
      </a>
    </button>
    


    

</aside>





  </main>
  <footer class="footer-top">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="footer-content">
            <div class="mb-4">
                <img src="https://static.cumulusnetworks.com/static/images/shared/cumulus-networks-rt-white-trademarked.ff839f1b2570.svg">
                <p>© <script type="text/javascript">document.write(new Date().getFullYear());</script> Cumulus Networks.<br>
                Site by <a href="//unomena.com/" target="_blank">Unomena</a>.</p>
            </div>
            <ul class="mb-4">
              <li><h4>Products</h4></li>
              <li><a href="//cumulusnetworks.com/products/cumulus-linux/">Cumulus Linux</a></li>
              <li><a href="//cumulusnetworks.com/products/netq/">Cumulus NetQ</a></li>
              <li><a href="//cumulusnetworks.com/products/cumulus-express/">Cumulus Express</a></li>
            </ul>
            <ul class="mb-4">
              <li><h4>Learn</h4></li>
              <li><a href="//cumulusnetworks.com/learn/web-scale-networking-education/">Going web-scale</a></li>
              <li><a href="//cumulusnetworks.com/learn/events/">Events</a></li>
              <li><a href="//cumulusnetworks.com/blog/">Blog</a></li>
            </ul>
            <ul class="mb-4">
              <li><h4>About</h4></li>
              <li><a href="//cumulusnetworks.com/about/">Our story</a></li>
              <li><a href="//cumulusnetworks.com/about/careers/">Careers</a></li>
              <li><a href="//cumulusnetworks.com/about/media-coverage/">Media coverage</a></li>
              <li><a href="//docs.cumulusnetworks.com/" target="_blank">Tech docs</a></li>
              <li><a href="//cumulusnetworks.com/community/">Community</a></li>
            </ul>
            <ul>
              <li>
                <a href="//twitter.com/CumulusNetworks/" target="_blank">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <defs>
                      <style>
                        .a{fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round}
                      </style>
                    </defs>
                    <path class="a" d="M23 6.628l-2-.5 1-2-2.464.7A4.48 4.48 0 0 0 12 8.128v1c-3.539.73-6.634-1.2-9.5-4.5q-.75 4 1.5 6l-3-.5c.405 2.069 1.362 3.7 4 4l-2.5 1c1 2 2.566 2.31 5 2.5a10.748 10.748 0 0 1-6.5 2c12.755 5.669 20-2.664 20-10V8.3z"></path>
                  </svg>
                </a>
              </li>
              <li>
                <a href="//www.facebook.com/CumulusNetworks/" target="_blank">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <defs>
                      <style>
                      .a{fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round}
                      </style>
                    </defs>
                    <path class="a" d="M17.768 7.5H13.5V5.6a.972.972 0 0 1 1.012-1.1c.418 0 2.988.01 2.988.01V.5h-4.329C9.244.5 8.5 3.474 8.5 5.355V7.5h-3v4h3v12h5v-12h3.851z"></path>
                  </svg>
                </a>
              </li>
              <li>
                <a href="//linkedin.com/company/cumulus-networks/" target="_blank">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <defs>
                      <style>
                      .a{fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round}
                      </style>
                    </defs>
                    <path class="a" d="M6.5 22.5h-5v-13h5zm9-9a2 2 0 0 0-2 2v7h-5v-13h5v1.485a6.307 6.307 0 0 1 3.99-1.495c2.962 0 5.01 2.2 5.01 6.355V22.5h-5v-7a2 2 0 0 0-2-2zM6.5 5A2.5 2.5 0 1 1 4 2.5 2.5 2.5 0 0 1 6.5 5z"></path>
                  </svg>
                </a>
              </li>
              <li>
                <a href="//vimeo.com/CumulusNetworks/" target="_blank">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <defs>
                      <style>
                        .a{fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round}
                      </style>
                    </defs>
                    <path class="a" d="M.5 7.393l.933 1.224S3.36 7.1 4 7.859s3.1 9.925 3.915 11.617c.714 1.483 2.684 3.444 4.845 2.042s9.34-7.529 10.626-14.769-8.642-5.723-9.693.583c2.627-1.577 4.03.642 2.686 3.154s-2.569 4.145-3.211 4.145-1.135-1.679-1.868-4.613c-.76-3.035-.755-8.5-3.911-7.882C4.412 2.721.5 7.393.5 7.393z"></path>
                  </svg>
                </a>
              </li>
              <li>
                <a href="//www.github.com/cumulusnetworks/" target="_blank">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <defs>
                        <style>
                        .a{fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round}
                        </style>
                    </defs>
                    <path class="a" d="M19.459 17c0-5.969-4.126-3.532-7.5-3.532s-7.5-2.375-7.5 3.532a3.5 3.5 0 0 0 3.5 3.5h8a3.5 3.5 0 0 0 3.5-3.5z"></path>
                    <path class="a" d="M21.489 10.214l.032.023s2.646-4.572-.6-7.237c-2 0-5.058 3.3-5.058 3.3l.022.016A14.152 14.152 0 0 0 8.1 6.3C8.083 6.285 5.037 3 3.042 3c-3.173 2.6-.729 7.012-.614 7.217a8.876 8.876 0 0 0-1.395 5.743c.241 3.126 2.847 6.54 5.982 6.54H16.9c3.135 0 5.742-3.414 5.982-6.54a8.857 8.857 0 0 0-1.393-5.746z"></path>
                    <ellipse class="a" cx="15.48" cy="17" rx="1" ry="1.5"></ellipse>
                    <ellipse class="a" cx="8.48" cy="17" rx="1" ry="1.5"></ellipse>
                  </svg>
                </a>
              </li>
              <li>
                <a href="//slack.cumulusnetworks.com/" target="_blank">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <defs>
                        <style>
                        .a{fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round}
                        </style>
                    </defs>
                    <rect class="a" x=".5" y=".5" width="23" height="23" rx="6" ry="6"></rect>
                    <circle class="a" cx="12" cy="12" r="6"></circle>
                    <circle class="a" cx="19" cy="5" r="1.5"></circle>
                  </svg>
                </a>
              </li>
              <li>
                <p>Cumulus Networks<sup>®</sup> — Data center networking software for the open, modern data center.</p>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </footer>
  <div class="footer-bottom">
      <div class="container">
          <div class="row">
              <div class="col-12">
                  <ul>
                      <li><a href="//cumulusnetworks.com/legal/trademarks/">Trademarks</a></li>
                      <li><a href="//cumulusnetworks.com/legal/privacy/">Privacy</a></li>
                      <li><a href="//cumulusnetworks.com/legal/">Terms of service</a></li>
                  </ul>
              </div>
          </div>
      </div>
  </div>

  
  

</body>

</html>
